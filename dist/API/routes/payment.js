"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,c){try{var u=r[o](c),i=u.value}catch(e){return void t(e)}return u.done?void e(i):Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)})}return n("next")})}}var _orderModel=require("../model/orderModel"),_orderModel2=_interopRequireDefault(_orderModel),_cartModel=require("../model/cartModel"),_cartModel2=_interopRequireDefault(_cartModel),express=require("express"),router=express.Router(),config=require("../db/config.js"),secret=require("../jwtSecret.js"),jwt=require("jsonwebtoken"),getCartSQL="SELECT _product.product_id, _product.product_name, _product.price, _cart_product.quantity, _product.discount  FROM _cart inner join _cart_product on _cart_product.cart_id = _cart.cart_id inner join _product on _product.product_id = _cart_product.product_id where user_id = ?",insertOrderSQL="insert into _order SET ?",insertProductSQL="insert into _order_product (order_id, product_id, quantity) VALUES ?";router.post("/createPayment",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t,n){var o,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.get("Authorization")||"",c=0,e.prev=2,e.delegateYield(regeneratorRuntime.mark(function e(){var i,a,d,s,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=jwt.verify(o,secret),a=new _cartModel2.default(r.body,n,o,getCartSQL),e.next=4,a.getCart();case 4:d=e.sent,d.forEach(function(e){c+=+e.price*+e.quantity}),u=require("stripe")(config.stripeSecret),s="gbp",p=r.body.description,u.tokens.create({card:{number:"4242424242424242",exp_month:12,exp_year:2018,cvc:"123"}}).then(function(e){return u.charges.create({amount:100*c,currency:s,description:p,source:e.id})}).then(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var u,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=new _orderModel2.default({payment_id:r.id,total_price:c},n,o,insertOrderSQL,d,insertProductSQL),e.next=3,u.addOrder();case 3:i=e.sent,t.json(r);case 5:case"end":return e.stop()}},e,void 0)}));return function(r){return e.apply(this,arguments)}}()).catch(function(e){console.log("ERROR",e);var r=e.statusCode?e.statusCode:400;t.status(r).json(e)});case 10:case"end":return e.stop()}},e,void 0)})(),"t0",4);case 4:e.next=10;break;case 6:e.prev=6,e.t1=e.catch(2),console.log(e.t1),t.status(400).json(e.t1);case 10:case"end":return e.stop()}},e,void 0,[[2,6]])}));return function(r,t,n){return e.apply(this,arguments)}}()),module.exports=router;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJvdXRlcy9wYXltZW50LmpzIl0sIm5hbWVzIjpbIl9vcmRlck1vZGVsIiwicmVxdWlyZSIsIl9jYXJ0TW9kZWwiLCJleHByZXNzIiwicm91dGVyIiwiUm91dGVyIiwiY29uZmlnIiwic2VjcmV0Iiwiand0IiwiZ2V0Q2FydFNRTCIsImluc2VydE9yZGVyU1FMIiwiaW5zZXJ0UHJvZHVjdFNRTCIsInBvc3QiLCJfcmVmIiwiX2FzeW5jVG9HZW5lcmF0b3IiLCJyZWdlbmVyYXRvclJ1bnRpbWUiLCJtYXJrIiwiX2NhbGxlZTMiLCJyZXEiLCJyZXMiLCJuZXh0IiwiYXV0aFRva2VuIiwidG90YWxQcmljZSIsInN0cmlwZSIsIndyYXAiLCJfY29udGV4dDMiLCJwcmV2IiwiZGVsZWdhdGVZaWVsZCIsIl9jYWxsZWUyIiwidG9rZW4iLCJjYXJ0TW9kZWwiLCJjYXJ0UmVzdWx0IiwiY3VycmVuY3kiLCJkZXNjcmlwdGlvbiIsIl9jb250ZXh0MiIsInZlcmlmeSIsIl9jYXJ0TW9kZWwyIiwiZGVmYXVsdCIsImJvZHkiLCJnZXRDYXJ0Iiwic2VudCIsImZvckVhY2giLCJyIiwicHJpY2UiLCJxdWFudGl0eSIsInN0cmlwZVNlY3JldCIsImdldCIsInRva2VucyIsImNyZWF0ZSIsImNhcmQiLCJudW1iZXIiLCJleHBfbW9udGgiLCJleHBfeWVhciIsImN2YyIsImNoYXJnZXMiLCJhbW91bnQiLCJzb3VyY2UiLCJpZCIsInRoZW4iLCJfcmVmMiIsIl9jYWxsZWUiLCJyZXNwb25zZSIsIm9yZGVyTW9kZWwiLCJvcmRlclJlc3VsdCIsIl9jb250ZXh0IiwiX29yZGVyTW9kZWwyIiwicGF5bWVudF9pZCIsInRvdGFsX3ByaWNlIiwiYWRkT3JkZXIiLCJqc29uIiwic3RvcCIsInVuZGVmaW5lZCIsIl94NCIsImFwcGx5IiwidGhpcyIsImFyZ3VtZW50cyIsImNhdGNoIiwiZXJyb3IiLCJzdGF0dXNDb2RlIiwidDEiLCJfeCIsIl94MiIsIl94MyIsIm1vZHVsZSIsImV4cG9y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MEIsRUFBQUEsT0FBQUEsS0FBQUEsS0FBQUEsRUFBQUEsR0FyQm9CLEtBQUEsSUFBQSxJQUFBLE1BQUEsTUFBQXhCLEdBQUE2QyxTQUFBckQsRUFBQXNELFNBQUEsRUFBQSxPQUE5QixPQUFBLFVBQUFTLEVBQUFDLEVBQUFDLEdBQUEsTUFBQXJFLEdBQUE0RCxNQUFBQyxLQUFBQyxnQkFxQmdCUSxPQUFBQyxRQUFBaEYiLCJmaWxlIjoicm91dGVzL3BheW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xudmFyIGNvbmZpZyA9IHJlcXVpcmUoJy4uL2RiL2NvbmZpZy5qcycpO1xudmFyIHNlY3JldCA9IHJlcXVpcmUoJy4uL2p3dFNlY3JldC5qcycpO1xudmFyIGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpO1xuXG5pbXBvcnQgT3JkZXJNb2RlbCBmcm9tICcuLi9tb2RlbC9vcmRlck1vZGVsJztcbmltcG9ydCBDYXJ0TW9kZWwgZnJvbSAnLi4vbW9kZWwvY2FydE1vZGVsJztcblxuY29uc3QgZ2V0Q2FydFNRTCA9ICdTRUxFQ1QgX3Byb2R1Y3QucHJvZHVjdF9pZCwgX3Byb2R1Y3QucHJvZHVjdF9uYW1lLCBfcHJvZHVjdC5wcmljZSwgX2NhcnRfcHJvZHVjdC5xdWFudGl0eSwgX3Byb2R1Y3QuZGlzY291bnQgIEZST00gX2NhcnQgaW5uZXIgam9pbiBfY2FydF9wcm9kdWN0IG9uIF9jYXJ0X3Byb2R1Y3QuY2FydF9pZCA9IF9jYXJ0LmNhcnRfaWQgaW5uZXIgam9pbiBfcHJvZHVjdCBvbiBfcHJvZHVjdC5wcm9kdWN0X2lkID0gX2NhcnRfcHJvZHVjdC5wcm9kdWN0X2lkIHdoZXJlIHVzZXJfaWQgPSA/JztcbmNvbnN0IGluc2VydE9yZGVyU1FMID0gJ2luc2VydCBpbnRvIF9vcmRlciBTRVQgPyc7XG5jb25zdCBpbnNlcnRQcm9kdWN0U1FMID0gXCJpbnNlcnQgaW50byBfb3JkZXJfcHJvZHVjdCAob3JkZXJfaWQsIHByb2R1Y3RfaWQsIHF1YW50aXR5KSBWQUxVRVMgP1wiO1xuXG5yb3V0ZXIucG9zdCgnL2NyZWF0ZVBheW1lbnQnLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcblxuICAgIGNvbnN0IGF1dGhUb2tlbiA9IHJlcS5nZXQoJ0F1dGhvcml6YXRpb24nKSB8fCBcIlwiO1xuICAgIGxldCB0b3RhbFByaWNlID0gMDtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdG9rZW4gPSBqd3QudmVyaWZ5KGF1dGhUb2tlbiwgc2VjcmV0KTtcblxuICAgICAgLy8gZ2V0IGNhcnQgZnJvbSB0YWJsZSAod2l0aCBwcmljZXMpXG5cbiAgICAgIGNvbnN0IGNhcnRNb2RlbCA9IG5ldyBDYXJ0TW9kZWwocmVxLmJvZHksIG5leHQsIGF1dGhUb2tlbiwgZ2V0Q2FydFNRTCk7XG4gICAgICBjb25zdCBjYXJ0UmVzdWx0ID0gYXdhaXQgY2FydE1vZGVsLmdldENhcnQoKTtcblxuICAgICAgY2FydFJlc3VsdC5mb3JFYWNoKChyKSA9PiB7XG4gICAgICAgIHRvdGFsUHJpY2UgKz0gKCtyLnByaWNlICogK3IucXVhbnRpdHkpXG4gICAgICB9KTtcblxuICAgICAgdmFyIHN0cmlwZSA9IHJlcXVpcmUoXCJzdHJpcGVcIikoY29uZmlnLnN0cmlwZVNlY3JldCk7XG4gICAgICBjb25zdCBjdXJyZW5jeSA9IFwiZ2JwXCI7XG4gICAgICBjb25zdCB7IGRlc2NyaXB0aW9uIH0gPSByZXEuYm9keTtcblxuICAgICAgc3RyaXBlLnRva2Vucy5jcmVhdGUoe1xuICAgICAgICAgIGNhcmQ6IHtcbiAgICAgICAgICAgIFwibnVtYmVyXCI6ICc0MjQyNDI0MjQyNDI0MjQyJyxcbiAgICAgICAgICAgIFwiZXhwX21vbnRoXCI6IDEyLFxuICAgICAgICAgICAgXCJleHBfeWVhclwiOiAyMDE4LFxuICAgICAgICAgICAgXCJjdmNcIjogJzEyMydcbiAgICAgICAgICB9XG4gICAgICB9KS50aGVuKCAodG9rZW4pID0+IHtcbiAgICAgICAgLy9jb25zb2xlLmxvZygnY3JlYXRlZCB0b2tlbicsIHRva2VuKTtcbiAgICAgICAgcmV0dXJuIHN0cmlwZS5jaGFyZ2VzLmNyZWF0ZSh7XG4gICAgICAgICAgICBhbW91bnQ6IHRvdGFsUHJpY2UgKiAxMDAsXG4gICAgICAgICAgICBjdXJyZW5jeSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgc291cmNlOiB0b2tlbi5pZFxuICAgICAgICB9KVxuICAgICAgfSApLnRoZW4oIGFzeW5jIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAvL2NvbnNvbGUubG9nKCdyZXNwb25zZSBmcm9tIHN0cmlwZScsIHJlc3BvbnNlKTtcblxuICAgICAgICBjb25zdCBvcmRlck1vZGVsID0gbmV3IE9yZGVyTW9kZWwoe3BheW1lbnRfaWQ6IHJlc3BvbnNlLmlkLCB0b3RhbF9wcmljZTogdG90YWxQcmljZX0sIG5leHQsIGF1dGhUb2tlbiwgaW5zZXJ0T3JkZXJTUUwsIGNhcnRSZXN1bHQsIGluc2VydFByb2R1Y3RTUUwpO1xuICAgICAgICBjb25zdCBvcmRlclJlc3VsdCA9IGF3YWl0IG9yZGVyTW9kZWwuYWRkT3JkZXIoKTtcblxuICAgICAgICByZXMuanNvbihyZXNwb25zZSk7XG4gICAgICB9ICkuY2F0Y2goIChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnRVJST1InLCBlcnJvcik7XG4gICAgICAgIGNvbnN0IGNvZGUgPSBlcnJvci5zdGF0dXNDb2RlID8gZXJyb3Iuc3RhdHVzQ29kZSA6IDQwMDtcbiAgICAgICAgcmVzLnN0YXR1cyhjb2RlKS5qc29uKGVycm9yKTtcbiAgICAgIH0gKVxuICAgIH0gY2F0Y2goZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuanNvbihlKTtcbiAgICB9XG5cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHJvdXRlcjtcbiJdfQ==
