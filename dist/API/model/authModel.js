"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(s,a){try{var o=t[s](a),i=o.value}catch(e){return void n(e)}return o.done?void e(i):Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)})}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),jwt=require("jsonwebtoken"),secret=require("../general/jwtSecret.js"),AuthModel=function(){function e(t,n,r,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";_classCallCheck(this,e),this.token=t,this.sql=a,this.data=n,this.res=r,this.next=s,this.secondSQL=o}return _createClass(e,[{key:"hashPassword",value:function(e){return new Promise(function(t,n){bcrypt.genSalt(saltRounds,function(r,s){r&&n(r),bcrypt.hash(e,s,function(e,r){e&&n(e),t(r)})})})}},{key:"comparePassword",value:function(e,t){return new Promise(function(n,r){bcrypt.compare(e,t,function(e,t){e&&r(e),n(t)})})}},{key:"forgotPasswordSetup",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,n=randomstring.generate({length:20,charset:"hex"}),e.next=7,t.query(this.sql,[n,this.data.email]);case 7:if(r=e.sent,!(r.changedRows>0)){e.next=19;break}return t.connection.release(),s="www.testsite.com",a="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+s+"/resetForgottenPassword/"+n+"\n\n After confirming your password you will be able to login.\n",o=new _email2.default(this.data.email,"forgotten-password@makeup.com","Forgotten Password",a,this.res),e.next=15,o.sendTokenEmail();case 15:i=e.sent,i&&this.res.json({success:"Email has been sent"}),e.next=21;break;case 19:throw t.connection.release(),new Error("User Does Not Exist");case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 27:case"end":return e.stop()}},e,this,[[0,23]])}));return e}()},{key:"changePassword",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.hashPassword(this.data.password);case 3:return n=e.sent,e.next=6,pool.getConnection();case 6:return r=e.sent,e.next=9,r.query(this.sql,[n,t]);case 9:if(s=e.sent,!(s.changedRows>0)){e.next=28;break}if("string"!=typeof t){e.next=24;break}return e.next=14,r.query(this.secondSQL,[t]);case 14:if(a=e.sent,!(a.changedRows>0)){e.next=20;break}r.connection.release(),this.res.status(200).json({success:!0}),e.next=22;break;case 20:throw r.connection.release(),new Error("User Does Not Exist");case 22:e.next=26;break;case 24:r.connection.release(),this.res.status(200).json({success:!0});case 26:e.next=30;break;case 28:throw r.connection.release(),new Error("User Does Not Exist");case 30:e.next=36;break;case 32:e.prev=32,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 36:case"end":return e.stop()}},e,this,[[0,32]])}));return e}()},{key:"confirmUser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.token]);case 6:if(n=e.sent,!(n.changedRows>0)){e.next=12;break}t.connection.release(),this.res.status(200).json({success:!0}),e.next=14;break;case 12:throw t.connection.release(),new Error("User Does Not Exist");case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 20:case"end":return e.stop()}},e,this,[[0,16]])}));return e}()},{key:"register",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a,o,i,c,u,l,h,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("HERE"),t=this.data,n=t.email,r=t.password,s=t.first_name,a=t.last_name,o=t.phone,i={email:n,password:r,first_name:s,last_name:a,phone:o},c=randomstring.generate({length:20,charset:"hex"}),i.token=c,e.next=8,pool.getConnection();case 8:return u=e.sent,e.next=11,u.query(this.sql,[this.data.email]);case 11:if(l=e.sent,!(l.length>0)){e.next=18;break}throw ÃŸ,u.connection.release(),new Error("Exists");case 18:return console.log("INSERT"),e.next=21,this.hashPassword(this.data.password);case 21:return h=e.sent,i.password=h,e.next=25,u.query(this.secondSQL,i);case 25:p=e.sent,console.log("insert result",p),p.affectedRows&&this.res.json({success:!0}),u.connection.release();case 29:e.next=35;break;case 31:e.prev=31,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 35:case"end":return e.stop()}},e,this,[[0,31]])}));return e}()},{key:"getUserFromToken",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=jwt.verify(this.token,secret),!t.user_id){e.next=13;break}return e.next=5,pool.getConnection();case 5:return n=e.sent,e.next=8,n.query(this.sql,[t.user_id]);case 8:r=e.sent,n.connection.release(),this.res.status(200).json({user_id:r[0].user_id,email:r[0].email,first_name:r[0].first_name,last_name:r[0].last_name,phone:r[0].phone}),e.next=15;break;case 13:connection.connection.release(),this.res.status(401).json({error:"Invalid Token"});case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 21:case"end":return e.stop()}},e,this,[[0,17]])}));return e}()},{key:"login",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.email]);case 6:if(n=e.sent,!(n.length>0)){e.next=22;break}return r=n[0].user_id,e.next=11,this.comparePassword(this.data.password,n[0].password);case 11:if(s=e.sent,!s){e.next=18;break}a=jwt.sign({user_id:r},secret,{expiresIn:"6h"}),t.connection.release(),this.res.status(200).json({user_id:n[0].user_id,email:n[0].email,first_name:n[0].first_name,last_name:n[0].last_name,phone:n[0].phone,token:a}),e.next=20;break;case 18:throw t.connection.release(),new Error("Incorrect Password");case 20:e.next=24;break;case 22:throw t.connection.release(),new Error("User Does Not Exist");case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 30:case"end":return e.stop()}},e,this,[[0,26]])}));return e}()}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJqd3QiLCJzZWNyZXQiLCJBdXRoTW9kZWwiLCJ0b2tlbiIsImRhdGEiLCJyZXMiLCJuZXh0Iiwic3FsIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwic2Vjb25kU1FMIiwiX2NsYXNzQ2FsbENoZWNrIiwidGhpcyIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJzYWx0IiwiaGFzaCIsInBhc3N3b3JkIiwiZGJQYXNzd29yZCIsImNvbXBhcmUiLCJjb21wYXJpc29uVmFsdWUiLCJnZXRDb25uZWN0aW9uIiwiY29ubmVjdGlvbiIsInF1ZXJ5IiwiZW1haWwiLCJyZXN1bHQiLCJjaGFuZ2VkUm93cyIsInJlbGVhc2UiLCJ1cmwiLCJlbWFpbENvbnRlbnQiLCJQcm9taXNlIiwiZW1haWxSZXNwb25zZSIsInN1Y2Nlc3MiLCJFcnJvciIsImNvbnNvbGUiLCJsb2ciLCJfY29udGV4dCIsInQwIiwiaWRlbnRpZmllciIsImhhc2hQYXNzd29yZCIsInNlY29uZFJlc3VsdCIsImpzb24iLCJjaGFyc2V0Iiwic3RhdHVzIiwiX2NvbnRleHQyIiwiX2NvbnRleHQzIiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsInBob25lIiwidXNlciIsInJlZ2lzdGVyVG9rZW4iLCJnZW5lcmF0ZSIsImVtYWlsQ2hlY2tSZXN1bHQiLCLDnyIsImluc2VydFJlc3VsdCIsImFmZmVjdGVkUm93cyIsIl9jb250ZXh0NCIsImRlY29kZWQiLCJ2ZXJpZnkiLCJ1c2VyX2lkIiwiZXJyb3IiLCJfY29udGV4dDUiLCJjb21wYXJlUGFzc3dvcmQiLCJtYXRjaCIsInNpZ24iLCJleHBpcmVzSW4iLCJfY29udGV4dDYiXSwibWFwcGluZ3MiOiJ5eUJBSUFBLE9BQUFDLFFBQUEsNERBSklDLE9BQVNELFFBQVEsVUFD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R0QsTUFDakJzQixXQUFZckIsRUFwR2VILEdBQUFBLFdBcUczQnlCLFVBQVd0QixFQUFPLEdBQUdzQixVQUNyQkMsTUFBT3ZCLEVBQU8sR0FBR3VCLGdDQUduQjFCLFdBQVdBLFdBeEdMa0IsVUF5R043QixLQUFLUixJQUFJd0MsT0FBTyxLQUFLRixNQUFNbUIsTUFBUyw0RUF2R2hDMUIsUUFBQUMsSUFBQTBCLEVBQUF4QixJQUNFTCxLQUFBQSxLQUFBQSxFQUFBQSxzVUFHU1YsS0FBQUEsNkJBQVhBLG1CQUNVVyxFQUFNVixNQUFBWixLQUFBTixLQStHMkJNLEtBQUtULEtBQUtzQixrQkFBckRDLFdBRUZBLEVBQU9sQixPQUFTLDBCQUNab0QsR0FBVWxDLEVBQU8sR0FBR2tDLGtCQUNOaEQsS0FBS21ELGdCQUFnQm5ELEtBQUtULEtBQUtlLFNBQVVRLEVBQU8sR0FBR1IscUJBQWpFOEMsVUFDRkEsbUJBQ0k5RCxFQUFRSCxJQUFJa0UsTUFBTUwsUUFBQUEsR0FBVTVELFFBbkgzQmtFLFVBQUEsT0FHTGpDLEVBQUFBLFdBQVNMLFVBRGVoQixLQUFBUixJQUExQndDLE9BQUEsS0FBQUYsTUF1SEVrQixRQUFTbEMsRUFBTyxHQUFHa0MsUUFDbkJuQyxNQUFPQyxFQUFPLEdBQUdELE1BQ2pCc0IsV0FBWXJCLEVBQU8sR0FBR3FCLFdBQ3RCQyxVQUFXdEIsRUFBTyxHQUFHc0IsVUFDckJDLE1BQU92QixFQUFPLEdBQUd1QixNQUNqQi9DLE1BQU9BLGlDQUdUcUIsR0FBV0EsV0FBV0ssVUFDaEIsR0FBSU0sT0FBTSwyREFHbEJYLEdBQVdBLFdBQVdLLFVBQ2hCLEdBQUlNLE9BQU0saUZBR2xCQyxRQUFRQyxJQUFSK0IsRUFBQTdCLElBOUhBSCxLQUFBQSxLQUFBQSxFQUFBQSxnR0FyR05sQyIsImZpbGUiOiJtb2RlbC9hdXRoTW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYmNyeXB0ID0gcmVxdWlyZSgnYmNyeXB0Jyk7XG52YXIgcG9vbCA9IHJlcXVpcmUoJy4uL2RiL2Nvbm5lY3QuanMnKTtcbmNvbnN0IHNhbHRSb3VuZHMgPSAxMDtcbmNvbnN0IHJhbmRvbXN0cmluZyA9IHJlcXVpcmUoJ3JhbmRvbXN0cmluZycpO1xuaW1wb3J0IEVtYWlsIGZyb20gJy4uL2VtYWlsL2VtYWlsLmpzJztcbnZhciBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcbnZhciBzZWNyZXQgPSByZXF1aXJlKCcuLi9nZW5lcmFsL2p3dFNlY3JldC5qcycpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRoTW9kZWwge1xuXG4gIGNvbnN0cnVjdG9yKHRva2VuLCBkYXRhLCByZXMsIG5leHQsIHNxbCA9ICcnLCBzZWNvbmRTUUwgPSAnJykge1xuICAgIHRoaXMudG9rZW4gPSB0b2tlbjtcbiAgICB0aGlzLnNxbCA9IHNxbDtcbiAgICB0aGlzLmRhdGEgPSBkYXRhO1xuICAgIHRoaXMucmVzID0gcmVzO1xuICAgIHRoaXMubmV4dCA9IG5leHQ7XG4gICAgdGhpcy5zZWNvbmRTUUwgPSBzZWNvbmRTUUw7XG4gIH1cblxuICBoYXNoUGFzc3dvcmQocGFzc3dvcmQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gIHtcbiAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGJjcnlwdC5oYXNoKHBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc29sdmUoaGFzaCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSlcbiAgfVxuXG4gIGNvbXBhcmVQYXNzd29yZChwYXNzd29yZCwgZGJQYXNzd29yZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBiY3J5cHQuY29tcGFyZShwYXNzd29yZCwgZGJQYXNzd29yZCwgKGVyciwgY29tcGFyaXNvblZhbHVlKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKGNvbXBhcmlzb25WYWx1ZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGZvcmdvdFBhc3N3b3JkU2V0dXAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCBwb29sLmdldENvbm5lY3Rpb24oKTtcbiAgICAgIGNvbnN0IHRva2VuID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtcbiAgICAgICAgbGVuZ3RoOiAyMCxcbiAgICAgICAgY2hhcnNldDogJ2hleCdcbiAgICAgIH0pO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3Rva2VuLCB0aGlzLmRhdGEuZW1haWxdKTtcbiAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIGNvbnN0IHVybCA9ICd3d3cudGVzdHNpdGUuY29tJztcbiAgICAgICAgdmFyIGVtYWlsQ29udGVudCA9ICdZb3UgYXJlIHJlY2VpdmluZyB0aGlzIGJlY2F1c2UgeW91IGhhdmUgcmVxdWVzdGVkIHRvIHJlc2V0IHlvdXIgcGFzc3dvcmQuICcgK1xuICAgICAgICAnUGxlYXNlIGNsaWNrIG9uIHRoZSBmb2xsb3dpbmcgbGluaywgb3IgcGFzdGUgdGhpcyBpbnRvIHlvdXIgYnJvd3NlciB0byBjb21wbGV0ZScgK1xuICAgICAgICAgJ3RoZSBwcm9jZXNzOlxcblxcbicgKyB1cmwgKyAnL3Jlc2V0Rm9yZ290dGVuUGFzc3dvcmQvJyArIHRva2VuICsgJ1xcblxcbiBBZnRlciBjb25maXJtaW5nIHlvdXIgcGFzc3dvcmQnICtcbiAgICAgICAgICcgeW91IHdpbGwgYmUgYWJsZSB0byBsb2dpbi5cXG4nO1xuICAgICAgICB2YXIgZW1haWwgPSBuZXcgRW1haWwodGhpcy5kYXRhLmVtYWlsLCAnZm9yZ290dGVuLXBhc3N3b3JkQG1ha2V1cC5jb20nLCAnRm9yZ290dGVuIFBhc3N3b3JkJywgZW1haWxDb250ZW50LCB0aGlzLnJlcyk7XG4gICAgICAgIGNvbnN0IGVtYWlsUmVzcG9uc2UgPSBhd2FpdCBlbWFpbC5zZW5kVG9rZW5FbWFpbCgpO1xuICAgICAgICBpZiAoZW1haWxSZXNwb25zZSkge1xuICAgICAgICAgIHRoaXMucmVzLmpzb24oe3N1Y2Nlc3M6ICdFbWFpbCBoYXMgYmVlbiBzZW50J30pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjaGFuZ2VQYXNzd29yZChpZGVudGlmaWVyKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhhc2ggPSBhd2FpdCB0aGlzLmhhc2hQYXNzd29yZCh0aGlzLmRhdGEucGFzc3dvcmQpO1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW2hhc2gsIGlkZW50aWZpZXJdKTtcbiAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgIC8vIGlmIHRoZSBpZGVudGlmaWVyIHdhcyB0aGUgdG9rZW4gLSBkbyBhbm90aGVyIHF1ZXJ5IHdoaWNoIHJlbW92ZXMgdGhlIHRva2VuXG4gICAgICAgIGlmICh0eXBlb2YgaWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBjb25zdCBzZWNvbmRSZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc2Vjb25kU1FMLCBbaWRlbnRpZmllcl0pO1xuICAgICAgICAgIGlmIChzZWNvbmRSZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgeyAvLyBub3JtYWwgY2hhbmdlIHBhc3N3b3JkIC0gc2VuZCBzdWNjZXNzXG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY29uZmlybVVzZXIoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICB2YXIgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS50b2tlbl0pO1xuICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgLy8gIGhvdyB0aGUgbXlzcWwgbGlicmFyeSBpcyB3cmFwcGVkIC0gc3RhY2tvdmVyZmxvd1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gIGhvdyB0aGUgbXlzcWwgbGlicmFyeSBpcyB3cmFwcGVkIC0gc3RhY2tvdmVyZmxvd1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZWdpc3RlcigpIHtcbiAgICB0cnkge1xuICAgICAgY29uc29sZS5sb2coJ0hFUkUnKTtcbiAgICAgIHZhciB7ZW1haWwsIHBhc3N3b3JkLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIHBob25lfSA9IHRoaXMuZGF0YTtcbiAgICAgIHZhciB1c2VyID0ge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX07XG4gICAgICBjb25zdCByZWdpc3RlclRva2VuID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtcbiAgICAgICAgbGVuZ3RoOiAyMCxcbiAgICAgICAgY2hhcnNldDogJ2hleCdcbiAgICAgIH0pO1xuICAgICAgdXNlci50b2tlbiA9IHJlZ2lzdGVyVG9rZW47XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCBlbWFpbENoZWNrUmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS5lbWFpbF0pO1xuICAgICAgaWYgKGVtYWlsQ2hlY2tSZXN1bHQubGVuZ3RoID4gMCkge8OfXG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRXhpc3RzJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnSU5TRVJUJyk7XG4gICAgICAgIGNvbnN0IGhhc2ggPSBhd2FpdCB0aGlzLmhhc2hQYXNzd29yZCh0aGlzLmRhdGEucGFzc3dvcmQpO1xuICAgICAgICB1c2VyLnBhc3N3b3JkID0gaGFzaDtcbiAgICAgICAgY29uc3QgaW5zZXJ0UmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNlY29uZFNRTCwgdXNlcik7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiaW5zZXJ0IHJlc3VsdFwiLCBpbnNlcnRSZXN1bHQpO1xuICAgICAgICBpZiAoaW5zZXJ0UmVzdWx0LmFmZmVjdGVkUm93cykge1xuICAgICAgICAgIHRoaXMucmVzLmpzb24oe1wic3VjY2Vzc1wiOiB0cnVlfSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB2YXIgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICAvLyB2YXIgcmVnaXN0ZXJFbWFpbENvbnRlbnQgPSAnWW91IGFyZSByZWNlaXZpbmcgdGhpcyBiZWNhdXNlIHlvdSAob3Igc29tZW9uZSBlbHNlKSBoYXZlIHNpZ25lZCB1cCAnICtcbiAgICAgICAgLy8gJ3RvIHRoZSB3ZWJzaXRlLlxcblxcbiBQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgIC8vICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvY29uZmlybUVtYWlsLycgKyB1c2VyLnRva2VuICsgJ1xcblxcbiBPbmNlIHlvdSBoYXZlIGNvbmZpcm1lZCB5b3VyIGFjY291bnQsJyArXG4gICAgICAgIC8vICAnIHlvdSB3aWxsIGJlIGFibGUgdG8gbG9naW4uXFxuJztcbiAgICAgICAgLy8gdmFyIEVtYWlsID0gbmV3IEVtYWlsKHRoaXMuZGF0YS5lbWFpbCwgJ3VzZXJjb25maXJtYXRpb25AbWFrZXVwLmNvbScsICdDb25maXJtIEFjY291bnQnLCByZWdpc3RlckVtYWlsQ29udGVudCwgdGhpcy5yZXMpO1xuICAgICAgLy8gICBjb25zdCBlbWFpbFJlc3BvbnNlID0gYXdhaXQgRW1haWwuc2VuZFRva2VuRW1haWwoKTtcbiAgICAgICAgLy8gaWYgKGVtYWlsUmVzcG9uc2UpIHtcbiAgICAgICAgLy8gICB0aGlzLnJlcy5qc29uKHtzdWNjZXNzOiAnRW1haWwgaGFzIGJlZW4gc2VudCd9KTtcbiAgICAgICAgLy8gfVxuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJGcm9tVG9rZW4oKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBqd3QudmVyaWZ5KHRoaXMudG9rZW4sIHNlY3JldCk7XG4gICAgICBpZiAoZGVjb2RlZC51c2VyX2lkKSB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCBwb29sLmdldENvbm5lY3Rpb24oKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW2RlY29kZWQudXNlcl9pZF0pO1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICB1c2VyX2lkOiByZXN1bHRbMF0udXNlcl9pZCxcbiAgICAgICAgICBlbWFpbDogcmVzdWx0WzBdLmVtYWlsLFxuICAgICAgICAgIGZpcnN0X25hbWU6IHJlc3VsdFswXS5maXJzdF9uYW1lLFxuICAgICAgICAgIGxhc3RfbmFtZTogcmVzdWx0WzBdLmxhc3RfbmFtZSxcbiAgICAgICAgICBwaG9uZTogcmVzdWx0WzBdLnBob25lXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDQwMSkuanNvbih7XCJlcnJvclwiOiBcIkludmFsaWQgVG9rZW5cIn0pO1xuICAgICAgfVxuXG5cbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxvZ2luKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLmVtYWlsXSk7XG5cbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCB1c2VyX2lkID0gcmVzdWx0WzBdLnVzZXJfaWQ7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gYXdhaXQgdGhpcy5jb21wYXJlUGFzc3dvcmQodGhpcy5kYXRhLnBhc3N3b3JkLCByZXN1bHRbMF0ucGFzc3dvcmQpO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICBjb25zdCB0b2tlbiA9IGp3dC5zaWduKHt1c2VyX2lkfSwgc2VjcmV0LCB7XG4gICAgICAgICAgZXhwaXJlc0luOiAnNmgnXG4gICAgICAgIH0pO1xuXG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHVzZXJfaWQ6IHJlc3VsdFswXS51c2VyX2lkLFxuICAgICAgICAgICAgZW1haWw6IHJlc3VsdFswXS5lbWFpbCxcbiAgICAgICAgICAgIGZpcnN0X25hbWU6IHJlc3VsdFswXS5maXJzdF9uYW1lLFxuICAgICAgICAgICAgbGFzdF9uYW1lOiByZXN1bHRbMF0ubGFzdF9uYW1lLFxuICAgICAgICAgICAgcGhvbmU6IHJlc3VsdFswXS5waG9uZSxcbiAgICAgICAgICAgIHRva2VuOiB0b2tlblxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbmNvcnJlY3QgUGFzc3dvcmQnKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==
