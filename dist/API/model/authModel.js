"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),AuthModel=function(){function e(n,o,t){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";_classCallCheck(this,e),this.sql=r,this.data=n,this.res=o,this.next=t,this.secondSQL=s}return _createClass(e,[{key:"forgotPasswordSetup",value:function(){var e=this;pool.getConnection().then(function(n){var o=randomstring.generate({length:20,charset:"hex"});return n.query(e.sql,[o,e.data.email]).then(function(t){if(!(t.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release();var r="www.testsite.com",s="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+r+"/resetForgottenPassword/"+o+"\n\n After confirming your password you will be able to login.\n",a=new _email2.default(e.data.email,"forgotten-password@makeup.com","Forgotten Password",s,e.res);a.sendTokenEmail()}).catch(function(n){n&&(console.log(n),e.next(n))})})}},{key:"changePassword",value:function(e){var n=this;pool.getConnection().then(function(o){try{bcrypt.genSalt(saltRounds,function(t,r){if(t)throw new Error(t);bcrypt.hash(n.data.password,r,function(t,r){if(t)throw new Error(t);return n.data.password=r,o.query(n.sql,[n.data.password,e]).then(function(t){if(console.log(t),!(t.changedRows>0))throw o.connection.release(),new Error("User Does Not Exist");"string"==typeof e&&o.query(n.secondSQL,[e]).then(function(e){if(!(e.changedRows>0))throw o.connection.release(),new Error("User Does Not Exist");o.connection.release(),n.res.status(200).json({success:!0})}).catch(function(e){throw o.connection.release(),new Error("User Does Not Exist")}),o.connection.release(),n.res.status(200).json({success:!0})}).catch(function(e){console.log(e),n.next(e)})})})}catch(e){console.log(e),n.next(e)}}).catch(function(e){console.log(e),n.next(e)})}},{key:"confirmUser",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.token]).then(function(o){if(console.log("result",o),!(o.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release(),e.res.status(200).json({success:!0})})}).catch(function(n){console.log(n),e.next(n)})}},{key:"register",value:function(){var e=this,n=this.data,o=n.email,t=n.password,r=n.first_name,s=n.last_name,a=n.phone,c={email:o,password:t,first_name:r,last_name:s,phone:a},i=randomstring.generate({length:20,charset:"hex"});c.token=i;try{if(!(o&&t&&r&&s&&a))throw console.log("error - not all fields"),new Error("Provide All Fields");pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(o){if(o.length>0)throw n.connection.release(),new Error("Exists");try{bcrypt.genSalt(saltRounds,function(o,t){if(o)throw n.connection.release(),new Error(o);bcrypt.hash(e.data.password,t,function(o,t){if(o)throw n.connection.release(),new Error(o);return c.password=t,pool.getConnection().then(function(n){return n.query("INSERT INTO _users SET ?",c).then(function(o){var t="www.testsite.com",r="You are receiving this because you (or someone else) have signed up to the website.\n\n Please click on the following link, or paste this into your browser to completethe process:\n\n"+t+"/confirmEmail/"+c.token+"\n\n Once you have confirmed your account, you will be able to login.\n",s=new _email2.default(e.data.email,"userconfirmation@makeup.com","Confirm Account",r,e.res);s.sendTokenEmail(),n.connection.release()})})})})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})}catch(e){console.log(e),this.next(e)}}},{key:"login",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(o){o.length>0&&bcrypt.compare(e.data.password,o[0].password,function(t,r){try{if(t)throw n.connection.release(),console.log(t),new Error(t);if(!r)throw n.connection.release(),new Error("Incorrect Password");n.connection.release(),console.log(o[0]),e.res.status(200).json({user_id:o[0].user_id,email:o[0].email,first_name:o[0].first_name,last_name:o[0].last_name,phone:o[0].phone})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})})}}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJBdXRoTW9kZWwiLCJkYXRhIiwicmVzIiwibmV4dCIsInNxbCIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsInNlY29uZFNRTCIsIl9jbGFzc0NhbGxDaGVjayIsInRoaXMiLCJfdGhpcyIsInRoZW4iLCJjb25uZWN0aW9uIiwiZ2VuZXJhdGUiLCJjaGFyc2V0IiwidG9rZW4iLCJlbWFpbCIsInJlc3VsdCIsImNoYW5nZWRSb3dzIiwicmVsZWFzZSIsIkVycm9yIiwidXJsIiwiZW1haWxDb250ZW50IiwiX2VtYWlsMiIsImRlZmF1bHQiLCJjYXRjaCIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJnZXRDb25uZWN0aW9uIiwiaWRlbnRpZmllciIsIl90aGlzMiIsImdlblNhbHQiLCJzYWx0IiwiaGFzaCIsInBhc3N3b3JkIiwicXVlcnkiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImVycm9yIiwiZSIsIl90aGlzMyIsIl90aGlzNCIsIl9kYXRhIiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsInBob25lIiwidXNlciIsInJlZ2lzdGVyVG9rZW4iLCJjb25uIiwicmVnaXN0ZXJFbWFpbENvbnRlbnQiLCJzZW5kVG9rZW5FbWFpbCIsIl90aGlzNSIsImNvbXBhcmUiLCJjb21wYXJpc29uVmFsdWUiLCJ1c2VyX2lkIl0sIm1hcHBpbmdzIjoiNGZBSUFBLE9BQUFDLFFBQUEsNERBSklDLE9BQVNELFFBQVEsVUFDakJFLEtBQU9GLFFBQVEsb0JBQ2JHLFdBQWEsR0FDYkMsYUFBZUosUUFBUSxnQkFHUksscUJBRnJCLFFBQUFBLEdBQUFDLEVBQUFDLEVBQUFDLEdBQUEsR0FBQUMsR0FBQUMsVUFBQUMsT0FBQSxHQUFBQyxTQUFBRixVQUFBLEdBQUFBLFVBQUEsR0FBQSxHQUFBRyxF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QUFDLElBQUFhLEdBK0JXWSxFQUFLbkQsS0FBS3VDLFFBSWZoQixNQUFNLFNBQUFDLEdBaENYOUIsUUFBS2lDLElBQUFBLEdBQ0h3QixFQUFBbkQsS0FBT1UsZ0NBcE9RYiIsImZpbGUiOiJtb2RlbC9hdXRoTW9kZWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYmNyeXB0ID0gcmVxdWlyZSgnYmNyeXB0Jyk7XG52YXIgcG9vbCA9IHJlcXVpcmUoJy4uL2RiL2Nvbm5lY3QuanMnKTtcbmNvbnN0IHNhbHRSb3VuZHMgPSAxMDtcbmNvbnN0IHJhbmRvbXN0cmluZyA9IHJlcXVpcmUoJ3JhbmRvbXN0cmluZycpO1xuaW1wb3J0IEVtYWlsIGZyb20gJy4uL2VtYWlsL2VtYWlsLmpzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0aE1vZGVsIHtcblxuICBjb25zdHJ1Y3RvcihkYXRhLCByZXMsIG5leHQsIHNxbCA9ICcnLCBzZWNvbmRTUUwgPSAnJykge1xuICAgIHRoaXMuc3FsID0gc3FsO1xuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgdGhpcy5yZXMgPSByZXM7XG4gICAgdGhpcy5uZXh0ID0gbmV4dDtcbiAgICB0aGlzLnNlY29uZFNRTCA9IHNlY29uZFNRTDtcbiAgfVxuXG4gIGZvcmdvdFBhc3N3b3JkU2V0dXAoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHZhciB0b2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICAgIGxlbmd0aDogMjAsXG4gICAgICAgIGNoYXJzZXQ6ICdoZXgnXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdG9rZW4sIHRoaXMuZGF0YS5lbWFpbF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgIHZhciB1cmwgPSAnd3d3LnRlc3RzaXRlLmNvbSc7XG4gICAgICAgICAgdmFyIGVtYWlsQ29udGVudCA9ICdZb3UgYXJlIHJlY2VpdmluZyB0aGlzIGJlY2F1c2UgeW91IGhhdmUgcmVxdWVzdGVkIHRvIHJlc2V0IHlvdXIgcGFzc3dvcmQuICcgK1xuICAgICAgICAgICdQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgICAgICd0aGUgcHJvY2VzczpcXG5cXG4nICsgdXJsICsgJy9yZXNldEZvcmdvdHRlblBhc3N3b3JkLycgKyB0b2tlbiArICdcXG5cXG4gQWZ0ZXIgY29uZmlybWluZyB5b3VyIHBhc3N3b3JkJyArXG4gICAgICAgICAgICcgeW91IHdpbGwgYmUgYWJsZSB0byBsb2dpbi5cXG4nO1xuICAgICAgICAgIHZhciBlbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICdmb3Jnb3R0ZW4tcGFzc3dvcmRAbWFrZXVwLmNvbScsICdGb3Jnb3R0ZW4gUGFzc3dvcmQnLCBlbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgICBlbWFpbC5zZW5kVG9rZW5FbWFpbCgpOyAvLyB0aGlzIHNlbmRzIGEgcmVzcG9uc2UgYWxzb1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgdGhpcy5uZXh0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gaGFzaFBhc3N3b3JkKHBhc3N3b3JkKSB7XG4gIC8vICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+ICB7XG4gIC8vICAgICBiY3J5cHQuZ2VuU2FsdChzYWx0Um91bmRzLCAoZXJyLCBzYWx0KSA9PiB7XG4gIC8vICAgICAgIGlmIChlcnIpIHtcbiAgLy8gICAgICAgICByZWplY3QoZXJyKTtcbiAgLy8gICAgICAgfVxuICAvLyAgICAgICBiY3J5cHQuaGFzaChwYXNzd29yZCwgc2FsdCwgKGVyciwgaGFzaCkgPT4ge1xuICAvLyAgICAgICAgIGlmIChlcnIpIHtcbiAgLy8gICAgICAgICAgIHJlamVjdChlcnIpO1xuICAvLyAgICAgICAgIH1cbiAgLy8gICAgICAgICByZXNvbHZlKGhhc2gpO1xuICAvLyAgICAgICB9KTtcbiAgLy8gICAgIH0pO1xuICAvLyAgIH0pXG4gIC8vIH1cbiAgLy9cbiAgLy8gdXBkYXRlUGFzc3dvcmQoY29ubmVjdGlvbiwgcGFzc3dvcmQsIGlkZW50aWZpZXIpIHtcbiAgLy8gICByZXR1cm4gY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3Bhc3N3b3JkLCBpZGVudGlmaWVyXSlcbiAgLy8gfVxuICAvLyByZW1vdmVUb2tlbihjb25uZWN0aW9uLCBpZGVudGlmaWVyKSB7XG4gIC8vICAgcmV0dXJuIGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zZWNvbmRTUUwsIFtpZGVudGlmaWVyXSk7XG4gIC8vIH1cbiAgLy8gY2hhbmdlUGFzc3dvcmROZXcoaWRlbnRpZmllcikge1xuICAvLyAgIHZhciBnZXRDb25uZWN0aW9uID0gcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gIC8vICAgdmFyIGhhc2hQYXNzd29yZCA9IGdldENvbm5lY3Rpb24udGhlbihjb25uZWN0aW9uID0+IHtcbiAgLy8gICAgIHJldHVybiB0aGlzLmhhc2hQYXNzd29yZCh0aGlzLmRhdGEucGFzc3dvcmQpO1xuICAvLyAgIH0pO1xuICAvLyAgIHZhciB1cGRhdGVQYXNzd29yZCA9IFByb21pc2UuYWxsKFtnZXRDb25uZWN0aW9uLCBoYXNoUGFzc3dvcmRdKS5zcHJlYWQoKGNvbm5lY3Rpb24sIHBhc3N3b3JkKSA9PiB7XG4gIC8vICAgICByZXR1cm4gdGhpcy51cGRhdGVQYXNzd29yZChjb25uZWN0aW9uLCBwYXNzd29yZCwgaWRlbnRpZmllcik7XG4gIC8vICAgfSk7XG4gIC8vICAgdmFyIHJlbW92ZVRva2VuID0gUHJvbWlzZS5hbGwoW2dldENvbm5lY3Rpb24sIGhhc2hQYXNzd29yZCwgdXBkYXRlUGFzc3dvcmRdKS5zcHJlYWQoKGNvbm5lY3Rpb24sIHBhc3N3b3JkLCByZXN1bHQpID0+IHtcbiAgLy8gICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7IC8vIGlmIHRoZSBpZGVudGlmaWVyIHdhcyB0aGUgdG9rZW4gLSBkbyBhbm90aGVyIHF1ZXJ5IHdoaWNoIHJlbW92ZXMgdGhlIHRva2VuXG4gIC8vICAgICAgIGlmICh0eXBlb2YgaWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHtcbiAgLy8gICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVUb2tlbihjb25uZWN0aW9uLCBpZGVudGlmaWVyKTtcbiAgLy8gICAgICAgfVxuICAvLyAgICAgfVxuICAvLyAgIH0pO1xuICAvLyAgIHJlbW92ZVRva2VuLnRoZW4oKCkgPT4ge1xuICAvLyAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtnZXRDb25uZWN0aW9uXSkuc3ByZWFkKGNvbm5lY3Rpb24gPT4ge1xuICAvLyAgICAgfSk7XG4gIC8vICAgfSk7XG4gIC8vIH1cblxuICBjaGFuZ2VQYXNzd29yZChpZGVudGlmaWVyKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYmNyeXB0Lmhhc2godGhpcy5kYXRhLnBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5kYXRhLnBhc3N3b3JkID0gaGFzaDtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnBhc3N3b3JkLCBpZGVudGlmaWVyXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXN1bHQpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIGlmIHRoZSBpZGVudGlmaWVyIHdhcyB0aGUgdG9rZW4gLSBkbyBhbm90aGVyIHF1ZXJ5IHdoaWNoIHJlbW92ZXMgdGhlIHRva2VuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpZGVudGlmaWVyID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNlY29uZFNRTCwgW2lkZW50aWZpZXJdKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG4gICAgICAgICAgICAgIHRoaXMubmV4dChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB0aGlzLm5leHQoZSk7XG4gICAgICB9XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbmZpcm1Vc2VyKCkge1xuICAgIHBvb2wuZ2V0Q29ubmVjdGlvbigpLnRoZW4oY29ubmVjdGlvbiA9PiB7XG4gICAgICByZXR1cm4gY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS50b2tlbl0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ3Jlc3VsdCcsIHJlc3VsdCk7XG4gICAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgICAgLy8gIGhvdyB0aGUgbXlzcWwgbGlicmFyeSBpcyB3cmFwcGVkIC0gc3RhY2tvdmVyZmxvd1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gIGhvdyB0aGUgbXlzcWwgbGlicmFyeSBpcyB3cmFwcGVkIC0gc3RhY2tvdmVyZmxvd1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgdGhpcy5uZXh0KGVycik7XG4gICAgfSk7XG4gIH1cblxuICByZWdpc3RlcigpIHtcbiAgICB2YXIge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX0gPSB0aGlzLmRhdGE7XG4gICAgdmFyIHVzZXIgPSB7ZW1haWwsIHBhc3N3b3JkLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIHBob25lfTtcbiAgICB2YXIgcmVnaXN0ZXJUb2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICBsZW5ndGg6IDIwLFxuICAgICAgY2hhcnNldDogJ2hleCdcbiAgICB9KTtcbiAgICB1c2VyLnRva2VuID0gcmVnaXN0ZXJUb2tlbjtcbiAgICB0cnkge1xuICAgICAgaWYgKCFlbWFpbCB8fCAhcGFzc3dvcmQgfHwgIWZpcnN0X25hbWUgfHwgIWxhc3RfbmFtZSB8fCAhcGhvbmUpIHtcbiAgICAgICAgLy8gdG8gZG8gd2l0aCB0aGUgbm9kZS1teXNxbCBsaWJyYXJ5XG4gICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciAtIG5vdCBhbGwgZmllbGRzJyk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvdmlkZSBBbGwgRmllbGRzJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwb29sLmdldENvbm5lY3Rpb24oKS50aGVuKGNvbm5lY3Rpb24gPT4ge1xuICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLmVtYWlsXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXhpc3RzJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBiY3J5cHQuaGFzaCh0aGlzLmRhdGEucGFzc3dvcmQsIHNhbHQsIChlcnIsIGhhc2gpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdXNlci5wYXNzd29yZCA9IGhhc2g7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwb29sLmdldENvbm5lY3Rpb24oKS50aGVuKGNvbm4gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25uLnF1ZXJ5KCdJTlNFUlQgSU5UTyBfdXNlcnMgU0VUID8nLCB1c2VyKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ2lzdGVyRW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgKG9yIHNvbWVvbmUgZWxzZSkgaGF2ZSBzaWduZWQgdXAgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAndG8gdGhlIHdlYnNpdGUuXFxuXFxuIFBsZWFzZSBjbGljayBvbiB0aGUgZm9sbG93aW5nIGxpbmssIG9yIHBhc3RlIHRoaXMgaW50byB5b3VyIGJyb3dzZXIgdG8gY29tcGxldGUnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvY29uZmlybUVtYWlsLycgKyB1c2VyLnRva2VuICsgJ1xcblxcbiBPbmNlIHlvdSBoYXZlIGNvbmZpcm1lZCB5b3VyIGFjY291bnQsJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW1haWwgPSBuZXcgRW1haWwodGhpcy5kYXRhLmVtYWlsLCAndXNlcmNvbmZpcm1hdGlvbkBtYWtldXAuY29tJywgJ0NvbmZpcm0gQWNjb3VudCcsIHJlZ2lzdGVyRW1haWxDb250ZW50LCB0aGlzLnJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbWFpbC5zZW5kVG9rZW5FbWFpbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29ubi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5uZXh0KGUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgbG9naW4oKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLmVtYWlsXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBMb2FkIGhhc2ggZnJvbSB5b3VyIHBhc3N3b3JkIERCLlxuICAgICAgICAgIGJjcnlwdC5jb21wYXJlKHRoaXMuZGF0YS5wYXNzd29yZCwgcmVzdWx0WzBdLnBhc3N3b3JkLCAoZXJyLCBjb21wYXJpc29uVmFsdWUpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAoY29tcGFyaXNvblZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXN1bHRbMF0pO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICAgICAgdXNlcl9pZDogcmVzdWx0WzBdLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogcmVzdWx0WzBdLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgZmlyc3RfbmFtZTogcmVzdWx0WzBdLmZpcnN0X25hbWUsXG4gICAgICAgICAgICAgICAgICBsYXN0X25hbWU6IHJlc3VsdFswXS5sYXN0X25hbWUsXG4gICAgICAgICAgICAgICAgICBwaG9uZTogcmVzdWx0WzBdLnBob25lXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0luY29ycmVjdCBQYXNzd29yZCcpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgICAgICB0aGlzLm5leHQoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgIHRoaXMubmV4dChlcnIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
