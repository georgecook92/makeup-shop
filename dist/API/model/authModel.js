"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(s,a){try{var o=t[s](a),i=o.value}catch(e){return void n(e)}return o.done?void e(i):Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)})}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),jwt=require("jsonwebtoken"),secret=require("../jwtSecret.js"),AuthModel=function(){function e(t,n,r,s){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";_classCallCheck(this,e),this.token=t,this.sql=a,this.data=n,this.res=r,this.next=s,this.secondSQL=o}return _createClass(e,[{key:"hashPassword",value:function(e){return new Promise(function(t,n){bcrypt.genSalt(saltRounds,function(r,s){r&&n(r),bcrypt.hash(e,s,function(e,r){e&&n(e),t(r)})})})}},{key:"comparePassword",value:function(e,t){return new Promise(function(n,r){bcrypt.compare(e,t,function(e,t){e&&r(e),n(t)})})}},{key:"forgotPasswordSetup",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,n=randomstring.generate({length:20,charset:"hex"}),e.next=7,t.query(this.sql,[n,this.data.email]);case 7:if(r=e.sent,!(r.changedRows>0)){e.next=19;break}return t.connection.release(),s="www.testsite.com",a="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+s+"/resetForgottenPassword/"+n+"\n\n After confirming your password you will be able to login.\n",o=new _email2.default(this.data.email,"forgotten-password@makeup.com","Forgotten Password",a,this.res),e.next=15,o.sendTokenEmail();case 15:i=e.sent,i&&this.res.json({success:"Email has been sent"}),e.next=21;break;case 19:throw t.connection.release(),new Error("User Does Not Exist");case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 27:case"end":return e.stop()}},e,this,[[0,23]])}));return e}()},{key:"changePassword",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.hashPassword(this.data.password);case 3:return n=e.sent,e.next=6,pool.getConnection();case 6:return r=e.sent,e.next=9,r.query(this.sql,[n,t]);case 9:if(s=e.sent,!(s.changedRows>0)){e.next=28;break}if("string"!=typeof t){e.next=24;break}return e.next=14,r.query(this.secondSQL,[t]);case 14:if(a=e.sent,!(a.changedRows>0)){e.next=20;break}r.connection.release(),this.res.status(200).json({success:!0}),e.next=22;break;case 20:throw r.connection.release(),new Error("User Does Not Exist");case 22:e.next=26;break;case 24:r.connection.release(),this.res.status(200).json({success:!0});case 26:e.next=30;break;case 28:throw r.connection.release(),new Error("User Does Not Exist");case 30:e.next=36;break;case 32:e.prev=32,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 36:case"end":return e.stop()}},e,this,[[0,32]])}));return e}()},{key:"confirmUser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.token]);case 6:if(n=e.sent,!(n.changedRows>0)){e.next=12;break}t.connection.release(),this.res.status(200).json({success:!0}),e.next=14;break;case 12:throw t.connection.release(),new Error("User Does Not Exist");case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 20:case"end":return e.stop()}},e,this,[[0,16]])}));return e}()},{key:"register",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a,o,i,c,u,l,h,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.data,n=t.email,r=t.password,s=t.first_name,a=t.last_name,o=t.phone,i={email:n,password:r,first_name:s,last_name:a,phone:o},c=randomstring.generate({length:20,charset:"hex"}),i.token=c,e.next=7,pool.getConnection();case 7:return u=e.sent,e.next=10,u.query(this.sql,[this.data.email]);case 10:if(l=e.sent,!(l.length>0)){e.next=17;break}throw ÃŸ,u.connection.release(),new Error("Exists");case 17:return console.log("INSERT"),e.next=20,this.hashPassword(this.data.password);case 20:return h=e.sent,i.password=h,e.next=24,u.query(this.secondSQL,i);case 24:p=e.sent,console.log("insert result",p),p.affectedRows&&this.res.json({success:!0}),u.connection.release();case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 34:case"end":return e.stop()}},e,this,[[0,30]])}));return e}()},{key:"getUserFromToken",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=jwt.verify(this.token,secret),!t.user_id){e.next=13;break}return e.next=5,pool.getConnection();case 5:return n=e.sent,e.next=8,n.query(this.sql,[t.user_id]);case 8:r=e.sent,n.connection.release(),this.res.status(200).json({user_id:r[0].user_id,email:r[0].email,first_name:r[0].first_name,last_name:r[0].last_name,phone:r[0].phone}),e.next=15;break;case 13:connection.connection.release(),this.res.status(401).json({error:"Invalid Token"});case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 21:case"end":return e.stop()}},e,this,[[0,17]])}));return e}()},{key:"login",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.email]);case 6:if(n=e.sent,!(n.length>0)){e.next=22;break}return r=n[0].user_id,e.next=11,this.comparePassword(this.data.password,n[0].password);case 11:if(s=e.sent,!s){e.next=18;break}a=jwt.sign({user_id:r},secret,{expiresIn:"6h"}),t.connection.release(),this.res.status(200).json({user_id:n[0].user_id,email:n[0].email,first_name:n[0].first_name,last_name:n[0].last_name,phone:n[0].phone,token:a}),e.next=20;break;case 18:throw t.connection.release(),new Error("Incorrect Password");case 20:e.next=24;break;case 22:throw t.connection.release(),new Error("User Does Not Exist");case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 30:case"end":return e.stop()}},e,this,[[0,26]])}));return e}()}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJqd3QiLCJzZWNyZXQiLCJBdXRoTW9kZWwiLCJ0b2tlbiIsImRhdGEiLCJyZXMiLCJuZXh0Iiwic3FsIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwidW5kZWZpbmVkIiwic2Vjb25kU1FMIiwiX2NsYXNzQ2FsbENoZWNrIiwidGhpcyIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJzYWx0IiwiaGFzaCIsInBhc3N3b3JkIiwiZGJQYXNzd29yZCIsImNvbXBhcmUiLCJjb21wYXJpc29uVmFsdWUiLCJnZXRDb25uZWN0aW9uIiwiY29ubmVjdGlvbiIsInF1ZXJ5IiwiZW1haWwiLCJyZXN1bHQiLCJjaGFuZ2VkUm93cyIsInJlbGVhc2UiLCJ1cmwiLCJlbWFpbENvbnRlbnQiLCJQcm9taXNlIiwiZW1haWxSZXNwb25zZSIsInN1Y2Nlc3MiLCJFcnJvciIsImNvbnNvbGUiLCJsb2ciLCJfY29udGV4dCIsInQwIiwiaWRlbnRpZmllciIsImhhc2hQYXNzd29yZCIsInNlY29uZFJlc3VsdCIsImpzb24iLCJjaGFyc2V0Iiwic3RhdHVzIiwiX2NvbnRleHQyIiwiX2NvbnRleHQzIiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsInBob25lIiwidXNlciIsInJlZ2lzdGVyVG9rZW4iLCJnZW5lcmF0ZSIsImVtYWlsQ2hlY2tSZXN1bHQiLCLDnyIsImluc2VydFJlc3VsdCIsImFmZmVjdGVkUm93cyIsIl9jb250ZXh0NCIsImRlY29kZWQiLCJ2ZXJpZnkiLCJ1c2VyX2lkIiwiX2NvbnRleHQ1IiwiY29tcGFyZVBhc3N3b3JkIiwibWF0Y2giLCJzaWduIiwiZXhwaXJlc0luIiwiX2NvbnRleHQ2Il0sIm1hcHBpbmdzIjoieXlCQUlBQSxPQUFBQyxRQUFBLDREQUpJQyxPQUFTRCxRQUFRLFVBQ2pCRSxLQUFP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QUFHcUIsV0FDdEJDLFVBQVd0QixFQXBHZ0JILEdBQUFBLFVBcUczQjBCLE1BQU92QixFQUFPLEdBQUd1QixnQ0FHbkIxQixXQUFXQSxXQUFXSyxVQUN0QmhCLEtBQUtSLElBQUl3QyxPQXhHSEgsS0FBQUEsTUFBYWQsTUFBQUEsNEVBQ2ZKLFFBQUFBLElBQUFBLEVBQUFBLElBQ0FYLEtBQUFQLEtBQUF3RCxFQUFBdkIsc1VBa0htQjFDLEtBQUswQiw2QkFBeEJDLG1CQTlHQUEsRUFBV0EsTUFBV0ssS0FBdEJ0QixLQUFBTSxLQUFBVCxLQUFBc0Isa0JBQUFGLFdBaUhGRyxFQUFPbEIsT0FBUywwQkFDWm9ELEdBQVVsQyxFQUFPLEdBQUdrQyxrQkFDTmhELEtBQUtrRCxnQkFBZ0JsRCxLQUFLVCxLQUFLZSxTQUFVUSxFQUFPLEdBQUdSLHFCQUFqRTZDLFVBQ0ZBLG1CQUNJN0QsRUFBUUgsSUFBSWlFLE1BQU1KLFFBQUFBLEdBQVU1RCxRQUNsQ2lFLFVBQVcsT0FqSFgxQyxFQUFLbkIsV0FBV3dCLFVBQ2RLLEtBQUFBLElBQUFBLE9BQUFBLEtBQVNTLE1BRGVrQixRQUExQmxDLEVBQUEsR0FBQWtDLFFBdUhFbkMsTUFBT0MsRUFBTyxHQUFHRCxNQUNqQnNCLFdBQVlyQixFQUFPLEdBQUdxQixXQUN0QkMsVUFBV3RCLEVBQU8sR0FBR3NCLFVBQ3JCQyxNQUFPdkIsRUFBTyxHQUFHdUIsTUFDakIvQyxNQUFPQSxpQ0FHVHFCLEdBQVdBLFdBeEhHSyxVQXlIUixHQUFJTSxPQUFNLDJEQUdsQlgsR0FBV0EsV0FBV0ssVUFDaEIsR0FBSU0sT0FBTSxpRkFHbEJDLFFBQVFDLElBQVI4QixFQUFBNUIsSUFDQTFCLEtBQUtQLEtBQUw2RCxFQUFBNUIsZ0dBbk9OckMiLCJmaWxlIjoibW9kZWwvYXV0aE1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xudmFyIHBvb2wgPSByZXF1aXJlKCcuLi9kYi9jb25uZWN0LmpzJyk7XG5jb25zdCBzYWx0Um91bmRzID0gMTA7XG5jb25zdCByYW5kb21zdHJpbmcgPSByZXF1aXJlKCdyYW5kb21zdHJpbmcnKTtcbmltcG9ydCBFbWFpbCBmcm9tICcuLi9lbWFpbC9lbWFpbC5qcyc7XG52YXIgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG52YXIgc2VjcmV0ID0gcmVxdWlyZSgnLi4vand0U2VjcmV0LmpzJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dGhNb2RlbCB7XG5cbiAgY29uc3RydWN0b3IodG9rZW4sIGRhdGEsIHJlcywgbmV4dCwgc3FsID0gJycsIHNlY29uZFNRTCA9ICcnKSB7XG4gICAgdGhpcy50b2tlbiA9IHRva2VuO1xuICAgIHRoaXMuc3FsID0gc3FsO1xuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgdGhpcy5yZXMgPSByZXM7XG4gICAgdGhpcy5uZXh0ID0gbmV4dDtcbiAgICB0aGlzLnNlY29uZFNRTCA9IHNlY29uZFNRTDtcbiAgfVxuXG4gIGhhc2hQYXNzd29yZChwYXNzd29yZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiAge1xuICAgICAgYmNyeXB0LmdlblNhbHQoc2FsdFJvdW5kcywgKGVyciwgc2FsdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgICAgYmNyeXB0Lmhhc2gocGFzc3dvcmQsIHNhbHQsIChlcnIsIGhhc2gpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZShoYXNoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KVxuICB9XG5cbiAgY29tcGFyZVBhc3N3b3JkKHBhc3N3b3JkLCBkYlBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCBkYlBhc3N3b3JkLCAoZXJyLCBjb21wYXJpc29uVmFsdWUpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoY29tcGFyaXNvblZhbHVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZm9yZ290UGFzc3dvcmRTZXR1cCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgdG9rZW4gPSByYW5kb21zdHJpbmcuZ2VuZXJhdGUoe1xuICAgICAgICBsZW5ndGg6IDIwLFxuICAgICAgICBjaGFyc2V0OiAnaGV4J1xuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdG9rZW4sIHRoaXMuZGF0YS5lbWFpbF0pO1xuICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgY29uc3QgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICB2YXIgZW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgaGF2ZSByZXF1ZXN0ZWQgdG8gcmVzZXQgeW91ciBwYXNzd29yZC4gJyArXG4gICAgICAgICdQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvcmVzZXRGb3Jnb3R0ZW5QYXNzd29yZC8nICsgdG9rZW4gKyAnXFxuXFxuIEFmdGVyIGNvbmZpcm1pbmcgeW91ciBwYXNzd29yZCcgK1xuICAgICAgICAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgIHZhciBlbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICdmb3Jnb3R0ZW4tcGFzc3dvcmRAbWFrZXVwLmNvbScsICdGb3Jnb3R0ZW4gUGFzc3dvcmQnLCBlbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgY29uc3QgZW1haWxSZXNwb25zZSA9IGF3YWl0IGVtYWlsLnNlbmRUb2tlbkVtYWlsKCk7XG4gICAgICAgIGlmIChlbWFpbFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5yZXMuanNvbih7c3VjY2VzczogJ0VtYWlsIGhhcyBiZWVuIHNlbnQnfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNoYW5nZVBhc3N3b3JkKGlkZW50aWZpZXIpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IHRoaXMuaGFzaFBhc3N3b3JkKHRoaXMuZGF0YS5wYXNzd29yZCk7XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbaGFzaCwgaWRlbnRpZmllcl0pO1xuICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgLy8gaWYgdGhlIGlkZW50aWZpZXIgd2FzIHRoZSB0b2tlbiAtIGRvIGFub3RoZXIgcXVlcnkgd2hpY2ggcmVtb3ZlcyB0aGUgdG9rZW5cbiAgICAgICAgaWYgKHR5cGVvZiBpZGVudGlmaWVyID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGNvbnN0IHNlY29uZFJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zZWNvbmRTUUwsIFtpZGVudGlmaWVyXSk7XG4gICAgICAgICAgaWYgKHNlY29uZFJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7IC8vIG5vcm1hbCBjaGFuZ2UgcGFzc3dvcmQgLSBzZW5kIHN1Y2Nlc3NcbiAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjb25maXJtVXNlcigpIHtcbiAgICB0cnkge1xuICAgICAgdmFyIGNvbm5lY3Rpb24gPSBhd2FpdCBwb29sLmdldENvbm5lY3Rpb24oKTtcbiAgICAgIHZhciByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnRva2VuXSk7XG4gICAgICBpZiAocmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlZ2lzdGVyKCkge1xuICAgIHRyeSB7XG4gICAgICB2YXIge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX0gPSB0aGlzLmRhdGE7XG4gICAgICB2YXIgdXNlciA9IHtlbWFpbCwgcGFzc3dvcmQsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgcGhvbmV9O1xuICAgICAgY29uc3QgcmVnaXN0ZXJUb2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICAgIGxlbmd0aDogMjAsXG4gICAgICAgIGNoYXJzZXQ6ICdoZXgnXG4gICAgICB9KTtcbiAgICAgIHVzZXIudG9rZW4gPSByZWdpc3RlclRva2VuO1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgZW1haWxDaGVja1Jlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEuZW1haWxdKTtcbiAgICAgIGlmIChlbWFpbENoZWNrUmVzdWx0Lmxlbmd0aCA+IDApIHvDn1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4aXN0cycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0lOU0VSVCcpO1xuICAgICAgICBjb25zdCBoYXNoID0gYXdhaXQgdGhpcy5oYXNoUGFzc3dvcmQodGhpcy5kYXRhLnBhc3N3b3JkKTtcbiAgICAgICAgdXNlci5wYXNzd29yZCA9IGhhc2g7XG4gICAgICAgIGNvbnN0IGluc2VydFJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zZWNvbmRTUUwsIHVzZXIpO1xuICAgICAgICBjb25zb2xlLmxvZyhcImluc2VydCByZXN1bHRcIiwgaW5zZXJ0UmVzdWx0KTtcbiAgICAgICAgaWYgKGluc2VydFJlc3VsdC5hZmZlY3RlZFJvd3MpIHtcbiAgICAgICAgICB0aGlzLnJlcy5qc29uKHtcInN1Y2Nlc3NcIjogdHJ1ZX0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdmFyIHVybCA9ICd3d3cudGVzdHNpdGUuY29tJztcbiAgICAgICAgLy8gdmFyIHJlZ2lzdGVyRW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgKG9yIHNvbWVvbmUgZWxzZSkgaGF2ZSBzaWduZWQgdXAgJyArXG4gICAgICAgIC8vICd0byB0aGUgd2Vic2l0ZS5cXG5cXG4gUGxlYXNlIGNsaWNrIG9uIHRoZSBmb2xsb3dpbmcgbGluaywgb3IgcGFzdGUgdGhpcyBpbnRvIHlvdXIgYnJvd3NlciB0byBjb21wbGV0ZScgK1xuICAgICAgICAvLyAgJ3RoZSBwcm9jZXNzOlxcblxcbicgKyB1cmwgKyAnL2NvbmZpcm1FbWFpbC8nICsgdXNlci50b2tlbiArICdcXG5cXG4gT25jZSB5b3UgaGF2ZSBjb25maXJtZWQgeW91ciBhY2NvdW50LCcgK1xuICAgICAgICAvLyAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgIC8vIHZhciBFbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICd1c2VyY29uZmlybWF0aW9uQG1ha2V1cC5jb20nLCAnQ29uZmlybSBBY2NvdW50JywgcmVnaXN0ZXJFbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgIC8vICAgY29uc3QgZW1haWxSZXNwb25zZSA9IGF3YWl0IEVtYWlsLnNlbmRUb2tlbkVtYWlsKCk7XG4gICAgICAgIC8vIGlmIChlbWFpbFJlc3BvbnNlKSB7XG4gICAgICAgIC8vICAgdGhpcy5yZXMuanNvbih7c3VjY2VzczogJ0VtYWlsIGhhcyBiZWVuIHNlbnQnfSk7XG4gICAgICAgIC8vIH1cbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRVc2VyRnJvbVRva2VuKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0aGlzLnRva2VuLCBzZWNyZXQpO1xuICAgICAgaWYgKGRlY29kZWQudXNlcl9pZCkge1xuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFtkZWNvZGVkLnVzZXJfaWRdKTtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgdXNlcl9pZDogcmVzdWx0WzBdLnVzZXJfaWQsXG4gICAgICAgICAgZW1haWw6IHJlc3VsdFswXS5lbWFpbCxcbiAgICAgICAgICBmaXJzdF9uYW1lOiByZXN1bHRbMF0uZmlyc3RfbmFtZSxcbiAgICAgICAgICBsYXN0X25hbWU6IHJlc3VsdFswXS5sYXN0X25hbWUsXG4gICAgICAgICAgcGhvbmU6IHJlc3VsdFswXS5waG9uZVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRoaXMucmVzLnN0YXR1cyg0MDEpLmpzb24oe1wiZXJyb3JcIjogXCJJbnZhbGlkIFRva2VuXCJ9KTtcbiAgICAgIH1cblxuXG4gICAgfSBjYXRjaChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2dpbigpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS5lbWFpbF0pO1xuXG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgdXNlcl9pZCA9IHJlc3VsdFswXS51c2VyX2lkO1xuICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IHRoaXMuY29tcGFyZVBhc3N3b3JkKHRoaXMuZGF0YS5wYXNzd29yZCwgcmVzdWx0WzBdLnBhc3N3b3JkKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7dXNlcl9pZH0sIHNlY3JldCwge1xuICAgICAgICAgIGV4cGlyZXNJbjogJzZoJ1xuICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICB1c2VyX2lkOiByZXN1bHRbMF0udXNlcl9pZCxcbiAgICAgICAgICAgIGVtYWlsOiByZXN1bHRbMF0uZW1haWwsXG4gICAgICAgICAgICBmaXJzdF9uYW1lOiByZXN1bHRbMF0uZmlyc3RfbmFtZSxcbiAgICAgICAgICAgIGxhc3RfbmFtZTogcmVzdWx0WzBdLmxhc3RfbmFtZSxcbiAgICAgICAgICAgIHBob25lOiByZXN1bHRbMF0ucGhvbmUsXG4gICAgICAgICAgICB0b2tlbjogdG9rZW5cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5jb3JyZWN0IFBhc3N3b3JkJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=
