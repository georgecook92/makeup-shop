"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../../../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),AuthModel=function(){function e(n,o,t){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";_classCallCheck(this,e),this.sql=r,this.data=n,this.res=o,this.next=t}return _createClass(e,[{key:"forgotPasswordSetup",value:function(){var e=this;pool.getConnection().then(function(n){var o=randomstring.generate({length:20,charset:"hex"});return n.query(e.sql,[o,e.data.email]).then(function(t){if(!(t.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release();var r="www.testsite.com",s="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+r+"/resetForgottenPassword/"+o+"\n\n After confirming your password you will be able to login.\n",a=new _email2.default(e.data.email,"forgotten-password@makeup.com","Forgotten Password",s,e.res);a.sendTokenEmail()}).catch(function(n){n&&(console.log(n),e.next(n))})})}},{key:"changePassword",value:function(){var e=this;pool.getConnection().then(function(n){try{bcrypt.genSalt(saltRounds,function(o,t){if(o)throw new Error(o);bcrypt.hash(e.data.password,t,function(o,t){if(o)throw new Error(o);return e.data.password=t,n.query(e.sql,[e.data.password,e.data.user_id]).then(function(o){if(console.log(o),!(o.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release(),e.res.status(200).json({success:!0})})})})}catch(n){console.log(n),e.next(n)}}).catch(function(n){console.log(n),e.next(n)})}},{key:"confirmUser",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.token]).then(function(o){if(console.log("result",o),!(o.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release(),e.res.status(200).json({success:!0})})}).catch(function(n){console.log(n),e.next(n)})}},{key:"register",value:function(){var e=this,n=this.data,o=n.email,t=n.password,r=n.first_name,s=n.last_name,a=n.phone,i={email:o,password:t,first_name:r,last_name:s,phone:a},c=randomstring.generate({length:20,charset:"hex"});i.token=c;try{if(!(o&&t&&r&&s&&a))throw console.log("error - not all fields"),new Error("Provide All Fields");pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(o){if(o.length>0)throw n.connection.release(),new Error("Exists");try{bcrypt.genSalt(saltRounds,function(o,t){if(o)throw n.connection.release(),new Error(o);bcrypt.hash(e.data.password,t,function(o,t){if(o)throw n.connection.release(),new Error(o);return i.password=t,pool.getConnection().then(function(n){return n.query("INSERT INTO _users SET ?",i).then(function(o){var t="www.testsite.com",r="You are receiving this because you (or someone else) have signed up to the website.\n\n Please click on the following link, or paste this into your browser to completethe process:\n\n"+t+"/confirmEmail/"+i.token+"\n\n Once you have confirmed your account, you will be able to login.\n",s=new _email2.default(e.data.email,"userconfirmation@makeup.com","Confirm Account",r,e.res);s.sendTokenEmail(),n.connection.release()})})})})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})}catch(e){console.log(e),this.next(e)}}},{key:"login",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(o){o.length>0&&bcrypt.compare(e.data.password,o[0].password,function(t,r){try{if(t)throw n.connection.release(),console.log(t),new Error(t);if(!r)throw n.connection.release(),new Error("Incorrect Password");n.connection.release(),console.log(o[0]),e.res.status(200).json({user_id:o[0].user_id,email:o[0].email,first_name:o[0].first_name,last_name:o[0].last_name,phone:o[0].phone})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})})}}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJBdXRoTW9kZWwiLCJkYXRhIiwicmVzIiwibmV4dCIsInNxbCIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsIl9jbGFzc0NhbGxDaGVjayIsInRoaXMiLCJfdGhpcyIsInRoZW4iLCJjb25uZWN0aW9uIiwiZ2VuZXJhdGUiLCJxdWVyeSIsInRva2VuIiwiZW1haWwiLCJyZXN1bHQiLCJjaGFuZ2VkUm93cyIsInJlbGVhc2UiLCJFcnJvciIsInVybCIsImVtYWlsQ29udGVudCIsIl9lbWFpbDIiLCJkZWZhdWx0IiwiY2F0Y2giLCJlcnIiLCJnZXRDb25uZWN0aW9uIiwiZ2VuU2FsdCIsInNhbHQiLCJoYXNoIiwiX3RoaXMyIiwicGFzc3dvcmQiLCJjb25zb2xlIiwibG9nIiwidXNlcl9pZCIsInN0YXR1cyIsImpzb24iLCJzdWNjZXNzIiwiZSIsIl90aGlzMyIsImxhc3RfbmFtZSIsInBob25lIiwicmVnaXN0ZXJUb2tlbiIsImZpcnN0X25hbWUiLCJfdGhpczQiLCJ1c2VyIiwicmVnaXN0ZXJFbWFpbENvbnRlbnQiLCJzZW5kVG9rZW5FbWFpbCIsImNvbm4iLCJfdGhpczUiLCJjb21wYXJlIiwiY29tcGFyaXNvblZhbHVlIl0sIm1hcHBpbmdzIjoiNGZBSUFBLE9BQUFDLFFBQUEsNERBSklDLE9BQVNELFFBQVEsVUFDakJFLEtBQU9GLFFBQVEsMEJBQ2JHLFdBQWEsR0FDYkMsYUFBZUosUUFBUSxnQkFHUksscUJBRnJCLFFBQUFBLEdBQUFDLEVBQUFDLEVBQUFDLEdBQUEsR0FBQUMsR0FBQUMsVUFBQUMsT0FBQSxHQUFBQyxTQUFBRixVQUFBLEdBQUFBLFVBQUEsR0FBQSxFQUFBRyxpQkFBQUMsS0FBQVQsR0FLSVMsS0FBS0wsSUFBTUEsRUFDWEssS0FBS1IsS0FBT0EsRUFD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QSxLQUFRa0MsRUFBQWpELEtBQUFlLFFBQVVMLEtBQUEsU0FBQU0sR0FDdEJELEVBQUFBLE9BQUFBLEdBRURwQixPQUFBdUQsUUFUTUQsRUFBUGpELEtBQUErQixTQUFBZixFQUFBLEdBQUFlLFNBQUEsU0FBQU4sRUFBQTBCLEdBVUQsSUFDRixHQUFBMUIsRUFJSE8sS0FGQ3JCLEdBekJEQSxXQUFBTyxVQTBCRGMsUUFBQ0MsSUFBVVIsR0FDVk8sR0FBUUMsT0FBUlIsRUFHSCxLQUFBMEIsRUFzQ0csS0EzQmJ4QyxHQUFBQSxXQUFBTyxVQTJCbUIsR0FBSUMsT0FBTSxxQkExRXRCUixHQUFBQSxXQUFBTyxVQXNDQ00sUUFBTVMsSUFBQWpCLEVBQU8sSUFDZGdCLEVBQVFDLElBQUlSLE9BQVosS0FBQVcsTUFDQUYsUUFBQWxCLEVBQUEsR0FBQWtCLFFBekNGbkIsTUFBQUMsRUFBQSxHQUFBRCxNQTJDRDRCLFdBQUEzQixFQUFBLEdBQUEyQixXQUNTSCxVQUFBeEIsRUFBQSxHQUFBd0IsVUFDRlAsTUFBUmpCLEVBQUEsR0FBQXlCLFFBZ0NRLE1BQU9ILEdBM0JYTixRQUFBQyxJQUFBSyxHQTZCSVcsRUFBSy9DLEtBQUtvQyxRQXpCZGQsTUFBQSxTQUFBQyxHQUNBOUIsUUFBQUEsSUFBT3VELEdBQ0xELEVBQUEvQyxLQUFJdUIsZ0NBMUtLMUIiLCJmaWxlIjoibW9kZWwvYXV0aE1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xudmFyIHBvb2wgPSByZXF1aXJlKCcuLi8uLi8uLi9kYi9jb25uZWN0LmpzJyk7XG5jb25zdCBzYWx0Um91bmRzID0gMTA7XG5jb25zdCByYW5kb21zdHJpbmcgPSByZXF1aXJlKCdyYW5kb21zdHJpbmcnKTtcbmltcG9ydCBFbWFpbCBmcm9tICcuLi9lbWFpbC9lbWFpbC5qcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dGhNb2RlbCB7XG5cbiAgY29uc3RydWN0b3IoZGF0YSwgcmVzLCBuZXh0LCBzcWwgPSAnJykge1xuICAgIHRoaXMuc3FsID0gc3FsO1xuICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgdGhpcy5yZXMgPSByZXM7XG4gICAgdGhpcy5uZXh0ID0gbmV4dDtcbiAgfVxuXG4gIGZvcmdvdFBhc3N3b3JkU2V0dXAoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHZhciB0b2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICAgIGxlbmd0aDogMjAsXG4gICAgICAgIGNoYXJzZXQ6ICdoZXgnXG4gICAgICB9KTtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdG9rZW4sIHRoaXMuZGF0YS5lbWFpbF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgIHZhciB1cmwgPSAnd3d3LnRlc3RzaXRlLmNvbSc7XG4gICAgICAgICAgdmFyIGVtYWlsQ29udGVudCA9ICdZb3UgYXJlIHJlY2VpdmluZyB0aGlzIGJlY2F1c2UgeW91IGhhdmUgcmVxdWVzdGVkIHRvIHJlc2V0IHlvdXIgcGFzc3dvcmQuICcgK1xuICAgICAgICAgICdQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgICAgICd0aGUgcHJvY2VzczpcXG5cXG4nICsgdXJsICsgJy9yZXNldEZvcmdvdHRlblBhc3N3b3JkLycgKyB0b2tlbiArICdcXG5cXG4gQWZ0ZXIgY29uZmlybWluZyB5b3VyIHBhc3N3b3JkJyArXG4gICAgICAgICAgICcgeW91IHdpbGwgYmUgYWJsZSB0byBsb2dpbi5cXG4nO1xuICAgICAgICAgIHZhciBlbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICdmb3Jnb3R0ZW4tcGFzc3dvcmRAbWFrZXVwLmNvbScsICdGb3Jnb3R0ZW4gUGFzc3dvcmQnLCBlbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgICBlbWFpbC5zZW5kVG9rZW5FbWFpbCgpOyAvLyB0aGlzIHNlbmRzIGEgcmVzcG9uc2UgYWxzb1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgdGhpcy5uZXh0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSk7XG5cblxuICB9XG5cbiAgY2hhbmdlUGFzc3dvcmQoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYmNyeXB0Lmhhc2godGhpcy5kYXRhLnBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5kYXRhLnBhc3N3b3JkID0gaGFzaDtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnBhc3N3b3JkLCB0aGlzLmRhdGEudXNlcl9pZF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIHRoaXMubmV4dChlKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgIHRoaXMubmV4dChlcnIpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uZmlybVVzZXIoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnRva2VuXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncmVzdWx0JywgcmVzdWx0KTtcbiAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJlZ2lzdGVyKCkge1xuICAgIHZhciB7ZW1haWwsIHBhc3N3b3JkLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIHBob25lfSA9IHRoaXMuZGF0YTtcbiAgICB2YXIgdXNlciA9IHtlbWFpbCwgcGFzc3dvcmQsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgcGhvbmV9O1xuICAgIHZhciByZWdpc3RlclRva2VuID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtcbiAgICAgIGxlbmd0aDogMjAsXG4gICAgICBjaGFyc2V0OiAnaGV4J1xuICAgIH0pO1xuICAgIHVzZXIudG9rZW4gPSByZWdpc3RlclRva2VuO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCB8fCAhZmlyc3RfbmFtZSB8fCAhbGFzdF9uYW1lIHx8ICFwaG9uZSkge1xuICAgICAgICAvLyB0byBkbyB3aXRoIHRoZSBub2RlLW15c3FsIGxpYnJhcnlcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIC0gbm90IGFsbCBmaWVsZHMnKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlIEFsbCBGaWVsZHMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBvb2wuZ2V0Q29ubmVjdGlvbigpLnRoZW4oY29ubmVjdGlvbiA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEuZW1haWxdKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeGlzdHMnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYmNyeXB0LmdlblNhbHQoc2FsdFJvdW5kcywgKGVyciwgc2FsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGJjcnlwdC5oYXNoKHRoaXMuZGF0YS5wYXNzd29yZCwgc2FsdCwgKGVyciwgaGFzaCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB1c2VyLnBhc3N3b3JkID0gaGFzaDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBvb2wuZ2V0Q29ubmVjdGlvbigpLnRoZW4oY29ubiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbm4ucXVlcnkoJ0lOU0VSVCBJTlRPIF91c2VycyBTRVQgPycsIHVzZXIpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSAnd3d3LnRlc3RzaXRlLmNvbSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVnaXN0ZXJFbWFpbENvbnRlbnQgPSAnWW91IGFyZSByZWNlaXZpbmcgdGhpcyBiZWNhdXNlIHlvdSAob3Igc29tZW9uZSBlbHNlKSBoYXZlIHNpZ25lZCB1cCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd0byB0aGUgd2Vic2l0ZS5cXG5cXG4gUGxlYXNlIGNsaWNrIG9uIHRoZSBmb2xsb3dpbmcgbGluaywgb3IgcGFzdGUgdGhpcyBpbnRvIHlvdXIgYnJvd3NlciB0byBjb21wbGV0ZScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICd0aGUgcHJvY2VzczpcXG5cXG4nICsgdXJsICsgJy9jb25maXJtRW1haWwvJyArIHVzZXIudG9rZW4gKyAnXFxuXFxuIE9uY2UgeW91IGhhdmUgY29uZmlybWVkIHlvdXIgYWNjb3VudCwnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAnIHlvdSB3aWxsIGJlIGFibGUgdG8gbG9naW4uXFxuJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICd1c2VyY29uZmlybWF0aW9uQG1ha2V1cC5jb20nLCAnQ29uZmlybSBBY2NvdW50JywgcmVnaXN0ZXJFbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVtYWlsLnNlbmRUb2tlbkVtYWlsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgICAgICAgICB0aGlzLm5leHQoZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgIHRoaXMubmV4dChlcnIpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBsb2dpbigpIHtcbiAgICBwb29sLmdldENvbm5lY3Rpb24oKS50aGVuKGNvbm5lY3Rpb24gPT4ge1xuICAgICAgcmV0dXJuIGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEuZW1haWxdKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIC8vIExvYWQgaGFzaCBmcm9tIHlvdXIgcGFzc3dvcmQgREIuXG4gICAgICAgICAgYmNyeXB0LmNvbXBhcmUodGhpcy5kYXRhLnBhc3N3b3JkLCByZXN1bHRbMF0ucGFzc3dvcmQsIChlcnIsIGNvbXBhcmlzb25WYWx1ZSkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmIChjb21wYXJpc29uVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdFswXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICAgICAgICB1c2VyX2lkOiByZXN1bHRbMF0udXNlcl9pZCxcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiByZXN1bHRbMF0uZW1haWwsXG4gICAgICAgICAgICAgICAgICBmaXJzdF9uYW1lOiByZXN1bHRbMF0uZmlyc3RfbmFtZSxcbiAgICAgICAgICAgICAgICAgIGxhc3RfbmFtZTogcmVzdWx0WzBdLmxhc3RfbmFtZSxcbiAgICAgICAgICAgICAgICAgIHBob25lOiByZXN1bHRbMF0ucGhvbmVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5jb3JyZWN0IFBhc3N3b3JkJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgICAgIHRoaXMubmV4dChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgdGhpcy5uZXh0KGVycik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
