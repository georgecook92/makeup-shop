"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,n){for(var o=0;o<n.length;o++){var t=n[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,o,t){return o&&e(n.prototype,o),t&&e(n,t),n}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../../../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),AuthModel=function(){function e(n,o,t,r){_classCallCheck(this,e),this.sql=n,this.data=o,this.res=t,this.next=r}return _createClass(e,[{key:"changePassword",value:function(){var e=this;pool.getConnection().then(function(n){try{bcrypt.genSalt(saltRounds,function(o,t){if(o)throw new Error(o);bcrypt.hash(e.data.password,t,function(o,t){if(o)throw new Error(o);return e.data.password=t,n.query(e.sql,[e.data.password,e.data.user_id]).then(function(o){if(console.log(o),!(o.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release(),e.res.status(200).json({success:!0})})})})}catch(n){console.log(n),e.next(n)}}).catch(function(n){console.log(n),e.next(n)})}},{key:"confirmUser",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.token]).then(function(o){if(console.log("result",o),!(o.changedRows>0))throw n.connection.release(),new Error("User Does Not Exist");n.connection.release(),e.res.status(200).json({success:!0})})}).catch(function(n){console.log(n),e.next(n)})}},{key:"register",value:function(){var e=this,n=this.data,o=n.email,t=n.password,r=n.first_name,s=n.last_name,a=n.phone,i={email:o,password:t,first_name:r,last_name:s,phone:a},c=randomstring.generate({length:20,charset:"hex"});i.token=c;try{if(!(o&&t&&r&&s&&a))throw console.log("error - not all fields"),new Error("Provide All Fields");pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(n){if(n.length>0)throw new Error("Exists");try{bcrypt.genSalt(saltRounds,function(n,o){if(n)throw new Error(n);bcrypt.hash(e.data.password,o,function(n,o){if(n)throw new Error(n);return i.password=o,pool.getConnection().then(function(n){return n.query("INSERT INTO _users SET ?",i).then(function(o){var t="www.testsite.com",r="You are receiving this because you (or someone else) have signed up to the website.\n\n Please click on the following link, or paste this into your browser to completethe process:\n\n"+t+"/confirmEmail/"+i.token+"\n\n Once you have confirmed your account, you will be able to login.\n",s=new _email2.default(e.data.email,"userconfirmation@makeup.com","Confirm Account",r,e.res);s.sendTokenEmail(),n.connection.release()})})})})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})}catch(e){console.log(e),this.next(e)}}},{key:"login",value:function(){var e=this;pool.getConnection().then(function(n){return n.query(e.sql,[e.data.email]).then(function(o){o.length>0&&bcrypt.compare(e.data.password,o[0].password,function(t,r){try{if(t)throw n.connection.release(),console.log(t),new Error(t);if(!r)throw n.connection.release(),new Error("Incorrect Password");n.connection.release(),console.log(o[0]),e.res.status(200).json({user_id:o[0].user_id,email:o[0].email,first_name:o[0].first_name,last_name:o[0].last_name,phone:o[0].phone})}catch(n){console.log(n),e.next(n)}})}).catch(function(n){console.log(n),e.next(n)})})}}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJBdXRoTW9kZWwiLCJzcWwiLCJkYXRhIiwicmVzIiwibmV4dCIsIl9jbGFzc0NhbGxDaGVjayIsInRoaXMiLCJfdGhpcyIsInRoZW4iLCJjb25uZWN0aW9uIiwiZXJyIiwic2FsdCIsIkVycm9yIiwiaGFzaCIsInBhc3N3b3JkIiwicXVlcnkiLCJ1c2VyX2lkIiwicmVzdWx0IiwiY29uc29sZSIsImxvZyIsImNoYW5nZWRSb3dzIiwiZ2V0Q29ubmVjdGlvbiIsInJlbGVhc2UiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImUiLCJjYXRjaCIsIl90aGlzMiIsInRva2VuIiwiX3RoaXMzIiwiX2RhdGEiLCJmaXJzdF9uYW1lIiwibGFzdF9uYW1lIiwicGhvbmUiLCJ1c2VyIiwibGVuZ3RoIiwiY2hhcnNldCIsInJlZ2lzdGVyVG9rZW4iLCJlbWFpbCIsImdlblNhbHQiLCJjb25uIiwicmVnaXN0ZXJFbWFpbENvbnRlbnQiLCJnZW5lcmF0ZSIsIl9lbWFpbDIiLCJkZWZhdWx0Iiwic2VuZFRva2VuRW1haWwiLCJfdGhpczQiLCJ1cmwiLCJjb21wYXJpc29uVmFsdWUiXSwibWFwcGluZ3MiOiI0ZkFJQUEsT0FBQUMsUUFBQSw0REFKSUMsT0FBU0QsUUFBUSxVQUNqQkUsS0FBT0YsUUFBUSwwQkFDYkcsV0FBYSxHQUNiQyxhQUFlSixRQUFRLGdCQUdSSyxxQkFGckIsUUFBQUEsR0FBQUMsRUFBQUMsRUFBQUMsRUFBQUMsR0FBQUMsZ0JBQUFDLEtBQUFOLEdBS0lNLEtBQUtMLElBQU1BLEVBQ1hLLEtBQUtKLEtBQU9BLEVBQ1pJLEtBQUtILElBQU1BLEVBQ1hHLEtBQUtGLEtBQU9BLGdFQUdHLEdBQUFHLEdBQUFELElBZmZWLE1BQUFBLGdCQUFpQlksS0FBckIsU0FBQUMsR0FDSVosSUFDRUMs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aXJlKCdiY3J5cHQnKTtcbnZhciBwb29sID0gcmVxdWlyZSgnLi4vLi4vLi4vZGIvY29ubmVjdC5qcycpO1xuY29uc3Qgc2FsdFJvdW5kcyA9IDEwO1xuY29uc3QgcmFuZG9tc3RyaW5nID0gcmVxdWlyZSgncmFuZG9tc3RyaW5nJyk7XG5pbXBvcnQgRW1haWwgZnJvbSAnLi4vZW1haWwvZW1haWwuanMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRoTW9kZWwge1xuXG4gIGNvbnN0cnVjdG9yKHNxbCwgZGF0YSwgcmVzLCBuZXh0KSB7XG4gICAgdGhpcy5zcWwgPSBzcWw7XG4gICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICB0aGlzLnJlcyA9IHJlcztcbiAgICB0aGlzLm5leHQgPSBuZXh0O1xuICB9XG5cbiAgY2hhbmdlUGFzc3dvcmQoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYmNyeXB0Lmhhc2godGhpcy5kYXRhLnBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5kYXRhLnBhc3N3b3JkID0gaGFzaDtcbiAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnBhc3N3b3JkLCB0aGlzLmRhdGEudXNlcl9pZF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgIHRoaXMubmV4dChlKTtcbiAgICAgIH1cbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgIHRoaXMubmV4dChlcnIpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uZmlybVVzZXIoKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLnRva2VuXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygncmVzdWx0JywgcmVzdWx0KTtcbiAgICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzZXIgRG9lcyBOb3QgRXhpc3QnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJlZ2lzdGVyKCkge1xuICAgIHZhciB7ZW1haWwsIHBhc3N3b3JkLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIHBob25lfSA9IHRoaXMuZGF0YTtcbiAgICB2YXIgdXNlciA9IHtlbWFpbCwgcGFzc3dvcmQsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgcGhvbmV9O1xuICAgIHZhciByZWdpc3RlclRva2VuID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtcbiAgICAgIGxlbmd0aDogMjAsXG4gICAgICBjaGFyc2V0OiAnaGV4J1xuICAgIH0pO1xuICAgIHVzZXIudG9rZW4gPSByZWdpc3RlclRva2VuO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCB8fCAhZmlyc3RfbmFtZSB8fCAhbGFzdF9uYW1lIHx8ICFwaG9uZSkge1xuICAgICAgICAvLyB0byBkbyB3aXRoIHRoZSBub2RlLW15c3FsIGxpYnJhcnlcbiAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIC0gbm90IGFsbCBmaWVsZHMnKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlIEFsbCBGaWVsZHMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBvb2wuZ2V0Q29ubmVjdGlvbigpLnRoZW4oY29ubmVjdGlvbiA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEuZW1haWxdKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFeGlzdHMnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYmNyeXB0LmdlblNhbHQoc2FsdFJvdW5kcywgKGVyciwgc2FsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGJjcnlwdC5oYXNoKHRoaXMuZGF0YS5wYXNzd29yZCwgc2FsdCwgKGVyciwgaGFzaCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdXNlci5wYXNzd29yZCA9IGhhc2g7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwb29sLmdldENvbm5lY3Rpb24oKS50aGVuKGNvbm4gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25uLnF1ZXJ5KCdJTlNFUlQgSU5UTyBfdXNlcnMgU0VUID8nLCB1c2VyKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ2lzdGVyRW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgKG9yIHNvbWVvbmUgZWxzZSkgaGF2ZSBzaWduZWQgdXAgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAndG8gdGhlIHdlYnNpdGUuXFxuXFxuIFBsZWFzZSBjbGljayBvbiB0aGUgZm9sbG93aW5nIGxpbmssIG9yIHBhc3RlIHRoaXMgaW50byB5b3VyIGJyb3dzZXIgdG8gY29tcGxldGUnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvY29uZmlybUVtYWlsLycgKyB1c2VyLnRva2VuICsgJ1xcblxcbiBPbmNlIHlvdSBoYXZlIGNvbmZpcm1lZCB5b3VyIGFjY291bnQsJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW1haWwgPSBuZXcgRW1haWwodGhpcy5kYXRhLmVtYWlsLCAndXNlcmNvbmZpcm1hdGlvbkBtYWtldXAuY29tJywgJ0NvbmZpcm0gQWNjb3VudCcsIHJlZ2lzdGVyRW1haWxDb250ZW50LCB0aGlzLnJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbWFpbC5zZW5kVG9rZW5FbWFpbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29ubi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5uZXh0KGUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgbG9naW4oKSB7XG4gICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgICAgIHJldHVybiBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLmVtYWlsXSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyBMb2FkIGhhc2ggZnJvbSB5b3VyIHBhc3N3b3JkIERCLlxuICAgICAgICAgIGJjcnlwdC5jb21wYXJlKHRoaXMuZGF0YS5wYXNzd29yZCwgcmVzdWx0WzBdLnBhc3N3b3JkLCAoZXJyLCBjb21wYXJpc29uVmFsdWUpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycik7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAoY29tcGFyaXNvblZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXN1bHRbMF0pO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICAgICAgdXNlcl9pZDogcmVzdWx0WzBdLnVzZXJfaWQsXG4gICAgICAgICAgICAgICAgICBlbWFpbDogcmVzdWx0WzBdLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgZmlyc3RfbmFtZTogcmVzdWx0WzBdLmZpcnN0X25hbWUsXG4gICAgICAgICAgICAgICAgICBsYXN0X25hbWU6IHJlc3VsdFswXS5sYXN0X25hbWUsXG4gICAgICAgICAgICAgICAgICBwaG9uZTogcmVzdWx0WzBdLnBob25lXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0luY29ycmVjdCBQYXNzd29yZCcpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgICAgICB0aGlzLm5leHQoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgIHRoaXMubmV4dChlcnIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==
