"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(s,o){try{var a=t[s](o),c=a.value}catch(e){return void n(e)}return a.done?void e(c):Promise.resolve(c).then(function(e){r("next",e)},function(e){r("throw",e)})}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),AuthModel=function(){function e(t,n,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";_classCallCheck(this,e),this.sql=s,this.data=t,this.res=n,this.next=r,this.secondSQL=o}return _createClass(e,[{key:"hashPassword",value:function(e){return new Promise(function(t,n){bcrypt.genSalt(saltRounds,function(r,s){r&&n(r),bcrypt.hash(e,s,function(e,r){e&&n(e),t(r)})})})}},{key:"comparePassword",value:function(e,t){return new Promise(function(n,r){bcrypt.compare(e,t,function(e,t){e&&r(e),n(t)})})}},{key:"forgotPasswordSetup",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,o,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,n=randomstring.generate({length:20,charset:"hex"}),e.next=7,t.query(this.sql,[n,this.data.email]);case 7:if(r=e.sent,!(r.changedRows>0)){e.next=19;break}return t.connection.release(),s="www.testsite.com",o="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+s+"/resetForgottenPassword/"+n+"\n\n After confirming your password you will be able to login.\n",a=new _email2.default(this.data.email,"forgotten-password@makeup.com","Forgotten Password",o,this.res),e.next=15,a.sendTokenEmail();case 15:c=e.sent,c&&this.res.json({success:"Email has been sent"}),e.next=21;break;case 19:throw t.connection.release(),new Error("User Does Not Exist");case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(0),console.log(err),this.next(err);case 27:case"end":return e.stop()}},e,this,[[0,23]])}));return e}()},{key:"changePassword",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.hashPassword(this.data.password);case 3:return n=e.sent,e.next=6,pool.getConnection();case 6:return r=e.sent,e.next=9,r.query(this.sql,[n,t]);case 9:if(s=e.sent,!(s.changedRows>0)){e.next=28;break}if("string"!=typeof t){e.next=24;break}return e.next=14,r.query(this.secondSQL,[t]);case 14:if(o=e.sent,!(o.changedRows>0)){e.next=20;break}r.connection.release(),this.res.status(200).json({success:!0}),e.next=22;break;case 20:throw r.connection.release(),new Error("User Does Not Exist");case 22:e.next=26;break;case 24:r.connection.release(),this.res.status(200).json({success:!0});case 26:e.next=30;break;case 28:throw r.connection.release(),new Error("User Does Not Exist");case 30:e.next=36;break;case 32:e.prev=32,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 36:case"end":return e.stop()}},e,this,[[0,32]])}));return e}()},{key:"confirmUser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.token]);case 6:if(n=e.sent,console.log(n.changedRows),!(n.changedRows>0)){e.next=13;break}t.connection.release(),this.res.status(200).json({success:!0}),e.next=15;break;case 13:throw t.connection.release(),new Error("User Does Not Exist");case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 21:case"end":return e.stop()}},e,this,[[0,17]])}));return e}()},{key:"register",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,o,a,c,i,u,l,h,p,f,d,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.data,n=t.email,r=t.password,s=t.first_name,o=t.last_name,a=t.phone,c={email:n,password:r,first_name:s,last_name:o,phone:a},i=randomstring.generate({length:20,charset:"hex"}),c.token=i,e.next=12,pool.getConnection();case 12:return u=e.sent,e.next=15,u.query(this.sql,[this.data.email]);case 15:if(l=e.sent,console.log(l),!(l.length>0)){e.next=22;break}throw u.connection.release(),new Error("Exists");case 22:return e.next=24,this.hashPassword(this.data.password);case 24:return h=e.sent,c.password=h,e.next=28,u.query(this.secondSQL,c);case 28:return p=e.sent,console.log(p),f="www.testsite.com",d="You are receiving this because you (or someone else) have signed up to the website.\n\n Please click on the following link, or paste this into your browser to completethe process:\n\n"+f+"/confirmEmail/"+c.token+"\n\n Once you have confirmed your account, you will be able to login.\n",n=new _email2.default(this.data.email,"userconfirmation@makeup.com","Confirm Account",d,this.res),e.next=35,n.sendTokenEmail();case 35:m=e.sent,m&&this.res.json({success:"Email has been sent"}),u.connection.release();case 38:e.next=44;break;case 40:e.prev=40,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 44:case"end":return e.stop()}},e,this,[[0,40]])}));return e}()},{key:"login",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.email]);case 6:if(n=e.sent,console.log("result",n),!(n.length>0)){e.next=21;break}return e.next=11,this.comparePassword(this.data.password,n[0].password);case 11:if(r=e.sent,!r){e.next=17;break}t.connection.release(),this.res.status(200).json({user_id:n[0].user_id,email:n[0].email,first_name:n[0].first_name,last_name:n[0].last_name,phone:n[0].phone}),e.next=19;break;case 17:throw t.connection.release(),new Error("Incorrect Password");case 19:e.next=23;break;case 21:throw t.connection.release(),new Error("User Does Not Exist");case 23:e.next=29;break;case 25:e.prev=25,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 29:case"end":return e.stop()}},e,this,[[0,25]])}));return e}()}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJBdXRoTW9kZWwiLCJkYXRhIiwicmVzIiwibmV4dCIsInNxbCIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsInNlY29uZFNRTCIsIl9jbGFzc0NhbGxDaGVjayIsInRoaXMiLCJwYXNzd29yZCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwic2FsdCIsImhhc2giLCJkYlBhc3N3b3JkIiwiY29tcGFyaXNvblZhbHVlIiwiZ2V0Q29ubmVjdGlvbiIsInRva2VuIiwiZ2VuZXJhdGUiLCJjaGFyc2V0IiwiY29ubmVjdGlvbiIsInF1ZXJ5IiwiZW1haWwiLCJyZXN1bHQiLCJjaGFuZ2VkUm93cyIsInJlbGVhc2UiLCJ1cmwiLCJlbWFpbENvbnRlbnQiLCJjb21wYXJlIiwic2VuZFRva2VuRW1haWwiLCJqc29uIiwic3VjY2VzcyIsIkVycm9yIiwiY29uc29sZSIsImxvZyIsImlkZW50aWZpZXIiLCJoYXNoUGFzc3dvcmQiLCJzdGF0dXMiLCJfY29udGV4dDIiLCJ0MCIsIl9jb250ZXh0MyIsImZpcnN0X25hbWUiLCJsYXN0X25hbWUiLCJwaG9uZSIsInVzZXIiLCJyZWdpc3RlclRva2VuIiwiZW1haWxDaGVja1Jlc3VsdCIsImluc2VydFJlc3VsdCIsInJlZ2lzdGVyRW1haWxDb250ZW50IiwiX2VtYWlsMiIsImRlZmF1bHQiLCJlbWFpbFJlc3BvbnNlIiwiX2NvbnRleHQ0IiwiY29tcGFyZVBhc3N3b3JkIiwibWF0Y2giLCJ1c2VyX2lkIiwiX2NvbnRleHQ1Il0sIm1hcHBpbmdzIjoieXlCQUlBQSxPQUFBQyxRQUFBLDREQUpJQyxPQUFTRCxRQUFRLFVBQ2pCRSxLQUFPRixRQUFRLG9CQUNiRyxXQUFhLEdBQ2JDLGFBQWVKLFFBQVEsZ0JBR1JLLHFCQUZyQixR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QUN0Qm5CLEtBQUtSLElBQUl1QyxPQUFPLEtBQUtQLE1BQ25CeUIsUUFBU2hDLEVBQU8sR0FBR2dDLFFBQ25CakMsTUFBT0MsRUFBTyxHQUFHRCxNQUNqQm1CLFdBQVlsQixFQUFPLEdBQUdrQixXQUN0QkMsVUFBV25CLEVBQU8sR0FBR21CLFVBQ3JCQyxNQUFPcEIsRUFBTyxHQUFHb0IscUNBR25CdkIsR0FBV0EsV0FBV0ssVUFDaEIsR0FBSU8sT0FBTSwyREFHbEJaLEdBQVdBLFdBQVdLLFVBQ2hCLEdBQUlPLE9BakpXdkMsaUZBQW5CMkIsUUFBQUEsSUFBQUEsRUFBQUEsSUFxSkpkLEtBQUtQLEtBQUx5RCxFQUFBakIsZ0dBNVBlM0MiLCJmaWxlIjoibW9kZWwvYXV0aE1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xudmFyIHBvb2wgPSByZXF1aXJlKCcuLi9kYi9jb25uZWN0LmpzJyk7XG5jb25zdCBzYWx0Um91bmRzID0gMTA7XG5jb25zdCByYW5kb21zdHJpbmcgPSByZXF1aXJlKCdyYW5kb21zdHJpbmcnKTtcbmltcG9ydCBFbWFpbCBmcm9tICcuLi9lbWFpbC9lbWFpbC5qcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dGhNb2RlbCB7XG5cbiAgY29uc3RydWN0b3IoZGF0YSwgcmVzLCBuZXh0LCBzcWwgPSAnJywgc2Vjb25kU1FMID0gJycpIHtcbiAgICB0aGlzLnNxbCA9IHNxbDtcbiAgICB0aGlzLmRhdGEgPSBkYXRhO1xuICAgIHRoaXMucmVzID0gcmVzO1xuICAgIHRoaXMubmV4dCA9IG5leHQ7XG4gICAgdGhpcy5zZWNvbmRTUUwgPSBzZWNvbmRTUUw7XG4gIH1cblxuICBoYXNoUGFzc3dvcmQocGFzc3dvcmQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gIHtcbiAgICAgIGJjcnlwdC5nZW5TYWx0KHNhbHRSb3VuZHMsIChlcnIsIHNhbHQpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIGJjcnlwdC5oYXNoKHBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc29sdmUoaGFzaCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSlcbiAgfVxuXG4gIGNvbXBhcmVQYXNzd29yZChwYXNzd29yZCxkYlBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCBkYlBhc3N3b3JkLCAoZXJyLCBjb21wYXJpc29uVmFsdWUpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJlc29sdmUoY29tcGFyaXNvblZhbHVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZm9yZ290UGFzc3dvcmRTZXR1cCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgdG9rZW4gPSByYW5kb21zdHJpbmcuZ2VuZXJhdGUoe1xuICAgICAgICBsZW5ndGg6IDIwLFxuICAgICAgICBjaGFyc2V0OiAnaGV4J1xuICAgICAgfSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdG9rZW4sIHRoaXMuZGF0YS5lbWFpbF0pO1xuICAgICAgaWYgKHJlc3VsdC5jaGFuZ2VkUm93cyA+IDApIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgY29uc3QgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICB2YXIgZW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgaGF2ZSByZXF1ZXN0ZWQgdG8gcmVzZXQgeW91ciBwYXNzd29yZC4gJyArXG4gICAgICAgICdQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvcmVzZXRGb3Jnb3R0ZW5QYXNzd29yZC8nICsgdG9rZW4gKyAnXFxuXFxuIEFmdGVyIGNvbmZpcm1pbmcgeW91ciBwYXNzd29yZCcgK1xuICAgICAgICAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgIHZhciBlbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICdmb3Jnb3R0ZW4tcGFzc3dvcmRAbWFrZXVwLmNvbScsICdGb3Jnb3R0ZW4gUGFzc3dvcmQnLCBlbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgY29uc3QgZW1haWxSZXNwb25zZSA9IGF3YWl0IGVtYWlsLnNlbmRUb2tlbkVtYWlsKCk7XG4gICAgICAgIGlmIChlbWFpbFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5yZXMuanNvbih7c3VjY2VzczogJ0VtYWlsIGhhcyBiZWVuIHNlbnQnfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB0aGlzLm5leHQoZXJyKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjaGFuZ2VQYXNzd29yZChpZGVudGlmaWVyKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhhc2ggPSBhd2FpdCB0aGlzLmhhc2hQYXNzd29yZCh0aGlzLmRhdGEucGFzc3dvcmQpO1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW2hhc2gsIGlkZW50aWZpZXJdKTtcbiAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgIC8vIGlmIHRoZSBpZGVudGlmaWVyIHdhcyB0aGUgdG9rZW4gLSBkbyBhbm90aGVyIHF1ZXJ5IHdoaWNoIHJlbW92ZXMgdGhlIHRva2VuXG4gICAgICAgIGlmICh0eXBlb2YgaWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBjb25zdCBzZWNvbmRSZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc2Vjb25kU1FMLCBbaWRlbnRpZmllcl0pO1xuICAgICAgICAgIGlmIChzZWNvbmRSZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgeyAvLyBub3JtYWwgY2hhbmdlIHBhc3N3b3JkIC0gc2VuZCBzdWNjZXNzXG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY29uZmlybVVzZXIoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICB2YXIgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS50b2tlbl0pO1xuICAgICAgY29uc29sZS5sb2cocmVzdWx0LmNoYW5nZWRSb3dzKTtcbiAgICAgIGlmIChyZXN1bHQuY2hhbmdlZFJvd3MgPiAwKSB7XG4gICAgICAgIC8vICBob3cgdGhlIG15c3FsIGxpYnJhcnkgaXMgd3JhcHBlZCAtIHN0YWNrb3ZlcmZsb3dcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgc3VjY2VzczogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vICBob3cgdGhlIG15c3FsIGxpYnJhcnkgaXMgd3JhcHBlZCAtIHN0YWNrb3ZlcmZsb3dcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVnaXN0ZXIoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHZhciB7ZW1haWwsIHBhc3N3b3JkLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUsIHBob25lfSA9IHRoaXMuZGF0YTtcbiAgICAgIHZhciB1c2VyID0ge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX07XG4gICAgICBjb25zdCByZWdpc3RlclRva2VuID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKHtcbiAgICAgICAgbGVuZ3RoOiAyMCxcbiAgICAgICAgY2hhcnNldDogJ2hleCdcbiAgICAgIH0pO1xuICAgICAgdXNlci50b2tlbiA9IHJlZ2lzdGVyVG9rZW47XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCBlbWFpbENoZWNrUmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS5lbWFpbF0pO1xuICAgICAgY29uc29sZS5sb2coZW1haWxDaGVja1Jlc3VsdCk7XG4gICAgICBpZiAoZW1haWxDaGVja1Jlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRXhpc3RzJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBoYXNoID0gYXdhaXQgdGhpcy5oYXNoUGFzc3dvcmQodGhpcy5kYXRhLnBhc3N3b3JkKTtcbiAgICAgICAgdXNlci5wYXNzd29yZCA9IGhhc2g7XG4gICAgICAgIGNvbnN0IGluc2VydFJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zZWNvbmRTUUwsIHVzZXIpO1xuICAgICAgICBjb25zb2xlLmxvZyhpbnNlcnRSZXN1bHQpO1xuICAgICAgICB2YXIgdXJsID0gJ3d3dy50ZXN0c2l0ZS5jb20nO1xuICAgICAgICB2YXIgcmVnaXN0ZXJFbWFpbENvbnRlbnQgPSAnWW91IGFyZSByZWNlaXZpbmcgdGhpcyBiZWNhdXNlIHlvdSAob3Igc29tZW9uZSBlbHNlKSBoYXZlIHNpZ25lZCB1cCAnICtcbiAgICAgICAgJ3RvIHRoZSB3ZWJzaXRlLlxcblxcbiBQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gICAgICAgICAndGhlIHByb2Nlc3M6XFxuXFxuJyArIHVybCArICcvY29uZmlybUVtYWlsLycgKyB1c2VyLnRva2VuICsgJ1xcblxcbiBPbmNlIHlvdSBoYXZlIGNvbmZpcm1lZCB5b3VyIGFjY291bnQsJyArXG4gICAgICAgICAnIHlvdSB3aWxsIGJlIGFibGUgdG8gbG9naW4uXFxuJztcbiAgICAgICAgdmFyIGVtYWlsID0gbmV3IEVtYWlsKHRoaXMuZGF0YS5lbWFpbCwgJ3VzZXJjb25maXJtYXRpb25AbWFrZXVwLmNvbScsICdDb25maXJtIEFjY291bnQnLCByZWdpc3RlckVtYWlsQ29udGVudCwgdGhpcy5yZXMpO1xuICAgICAgICBjb25zdCBlbWFpbFJlc3BvbnNlID0gYXdhaXQgZW1haWwuc2VuZFRva2VuRW1haWwoKTtcbiAgICAgICAgaWYgKGVtYWlsUmVzcG9uc2UpIHtcbiAgICAgICAgICB0aGlzLnJlcy5qc29uKHtzdWNjZXNzOiAnRW1haWwgaGFzIGJlZW4gc2VudCd9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cblxuICB9XG5cbiAgLy8gcmVnaXN0ZXIoKSB7XG4gIC8vICAgdmFyIHtlbWFpbCwgcGFzc3dvcmQsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgcGhvbmV9ID0gdGhpcy5kYXRhO1xuICAvLyAgIHZhciB1c2VyID0ge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX07XG4gIC8vICAgdmFyIHJlZ2lzdGVyVG9rZW4gPSByYW5kb21zdHJpbmcuZ2VuZXJhdGUoe1xuICAvLyAgICAgbGVuZ3RoOiAyMCxcbiAgLy8gICAgIGNoYXJzZXQ6ICdoZXgnXG4gIC8vICAgfSk7XG4gIC8vICAgdXNlci50b2tlbiA9IHJlZ2lzdGVyVG9rZW47XG4gIC8vICAgdHJ5IHtcbiAgLy8gICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkIHx8ICFmaXJzdF9uYW1lIHx8ICFsYXN0X25hbWUgfHwgIXBob25lKSB7XG4gIC8vICAgICAgIC8vIHRvIGRvIHdpdGggdGhlIG5vZGUtbXlzcWwgbGlicmFyeVxuICAvLyAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgLSBub3QgYWxsIGZpZWxkcycpO1xuICAvLyAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGUgQWxsIEZpZWxkcycpO1xuICAvLyAgICAgfSBlbHNlIHtcbiAgLy8gICAgICAgcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uZWN0aW9uID0+IHtcbiAgLy8gICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS5lbWFpbF0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgLy8gICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAvLyAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAvLyAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4aXN0cycpO1xuICAvLyAgICAgICAgICAgfSBlbHNlIHtcbiAgLy8gICAgICAgICAgICAgdHJ5IHtcbiAgLy8gICAgICAgICAgICAgICBiY3J5cHQuZ2VuU2FsdChzYWx0Um91bmRzLCAoZXJyLCBzYWx0KSA9PiB7XG4gIC8vICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gIC8vICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gIC8vICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAvLyAgICAgICAgICAgICAgICAgfVxuICAvLyAgICAgICAgICAgICAgICAgYmNyeXB0Lmhhc2godGhpcy5kYXRhLnBhc3N3b3JkLCBzYWx0LCAoZXJyLCBoYXNoKSA9PiB7XG4gIC8vICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgLy8gICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAvLyAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAvLyAgICAgICAgICAgICAgICAgICB9XG4gIC8vICAgICAgICAgICAgICAgICAgIHVzZXIucGFzc3dvcmQgPSBoYXNoO1xuICAvLyAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9vbC5nZXRDb25uZWN0aW9uKCkudGhlbihjb25uID0+IHtcbiAgLy8gICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29ubi5xdWVyeSgnSU5TRVJUIElOVE8gX3VzZXJzIFNFVCA/JywgdXNlcikudGhlbihyZXN1bHQgPT4ge1xuICAvLyAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9ICd3d3cudGVzdHNpdGUuY29tJztcbiAgLy8gICAgICAgICAgICAgICAgICAgICAgIHZhciByZWdpc3RlckVtYWlsQ29udGVudCA9ICdZb3UgYXJlIHJlY2VpdmluZyB0aGlzIGJlY2F1c2UgeW91IChvciBzb21lb25lIGVsc2UpIGhhdmUgc2lnbmVkIHVwICcgK1xuICAvLyAgICAgICAgICAgICAgICAgICAgICAgJ3RvIHRoZSB3ZWJzaXRlLlxcblxcbiBQbGVhc2UgY2xpY2sgb24gdGhlIGZvbGxvd2luZyBsaW5rLCBvciBwYXN0ZSB0aGlzIGludG8geW91ciBicm93c2VyIHRvIGNvbXBsZXRlJyArXG4gIC8vICAgICAgICAgICAgICAgICAgICAgICAgJ3RoZSBwcm9jZXNzOlxcblxcbicgKyB1cmwgKyAnL2NvbmZpcm1FbWFpbC8nICsgdXNlci50b2tlbiArICdcXG5cXG4gT25jZSB5b3UgaGF2ZSBjb25maXJtZWQgeW91ciBhY2NvdW50LCcgK1xuICAvLyAgICAgICAgICAgICAgICAgICAgICAgICcgeW91IHdpbGwgYmUgYWJsZSB0byBsb2dpbi5cXG4nO1xuICAvLyAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVtYWlsID0gbmV3IEVtYWlsKHRoaXMuZGF0YS5lbWFpbCwgJ3VzZXJjb25maXJtYXRpb25AbWFrZXVwLmNvbScsICdDb25maXJtIEFjY291bnQnLCByZWdpc3RlckVtYWlsQ29udGVudCwgdGhpcy5yZXMpO1xuICAvLyAgICAgICAgICAgICAgICAgICAgICAgZW1haWwuc2VuZFRva2VuRW1haWwoKTtcbiAgLy8gICAgICAgICAgICAgICAgICAgICAgIGNvbm4uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gIC8vICAgICAgICAgICAgICAgICAgICAgfSk7XG4gIC8vICAgICAgICAgICAgICAgICAgIH0pO1xuICAvLyAgICAgICAgICAgICAgICAgfVxuICAvLyAgICAgICAgICAgICAgICAgKTtcbiAgLy8gICAgICAgICAgICAgICB9KTtcbiAgLy8gICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAvLyAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAvLyAgICAgICAgICAgICAgIHRoaXMubmV4dChlKTtcbiAgLy8gICAgICAgICAgICAgfVxuICAvLyAgICAgICAgICAgfVxuICAvLyAgICAgICAgIH0pO1xuICAvLyAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAvLyAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gIC8vICAgICAgICAgdGhpcy5uZXh0KGVycik7XG4gIC8vICAgICAgIH0pO1xuICAvLyAgICAgfVxuICAvLyAgIH0gY2F0Y2ggKGUpIHtcbiAgLy8gICAgIGNvbnNvbGUubG9nKGUpO1xuICAvLyAgICAgdGhpcy5uZXh0KGUpO1xuICAvLyAgIH1cbiAgLy8gfVxuXG4gIGFzeW5jIGxvZ2luKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc3FsLCBbdGhpcy5kYXRhLmVtYWlsXSk7XG4gICAgICBjb25zb2xlLmxvZygncmVzdWx0JywgcmVzdWx0KTtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBtYXRjaCA9IGF3YWl0IHRoaXMuY29tcGFyZVBhc3N3b3JkKHRoaXMuZGF0YS5wYXNzd29yZCwgcmVzdWx0WzBdLnBhc3N3b3JkKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICB0aGlzLnJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIHVzZXJfaWQ6IHJlc3VsdFswXS51c2VyX2lkLFxuICAgICAgICAgICAgZW1haWw6IHJlc3VsdFswXS5lbWFpbCxcbiAgICAgICAgICAgIGZpcnN0X25hbWU6IHJlc3VsdFswXS5maXJzdF9uYW1lLFxuICAgICAgICAgICAgbGFzdF9uYW1lOiByZXN1bHRbMF0ubGFzdF9uYW1lLFxuICAgICAgICAgICAgcGhvbmU6IHJlc3VsdFswXS5waG9uZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbmNvcnJlY3QgUGFzc3dvcmQnKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
