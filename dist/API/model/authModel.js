"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(s,o){try{var a=t[s](o),i=a.value}catch(e){return void n(e)}return a.done?void e(i):Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)})}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_email=require("../email/email.js"),_email2=_interopRequireDefault(_email),bcrypt=require("bcrypt"),pool=require("../db/connect.js"),saltRounds=10,randomstring=require("randomstring"),jwt=require("json-web-token"),secret=require("../general/jwtSecret.js"),AuthModel=function(){function e(t,n,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";_classCallCheck(this,e),this.sql=s,this.data=t,this.res=n,this.next=r,this.secondSQL=o}return _createClass(e,[{key:"hashPassword",value:function(e){return new Promise(function(t,n){bcrypt.genSalt(saltRounds,function(r,s){r&&n(r),bcrypt.hash(e,s,function(e,r){e&&n(e),t(r)})})})}},{key:"comparePassword",value:function(e,t){return new Promise(function(n,r){bcrypt.compare(e,t,function(e,t){e&&r(e),n(t)})})}},{key:"forgotPasswordSetup",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,o,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,n=randomstring.generate({length:20,charset:"hex"}),e.next=7,t.query(this.sql,[n,this.data.email]);case 7:if(r=e.sent,!(r.changedRows>0)){e.next=19;break}return t.connection.release(),s="www.testsite.com",o="You are receiving this because you have requested to reset your password. Please click on the following link, or paste this into your browser to completethe process:\n\n"+s+"/resetForgottenPassword/"+n+"\n\n After confirming your password you will be able to login.\n",a=new _email2.default(this.data.email,"forgotten-password@makeup.com","Forgotten Password",o,this.res),e.next=15,a.sendTokenEmail();case 15:i=e.sent,i&&this.res.json({success:"Email has been sent"}),e.next=21;break;case 19:throw t.connection.release(),new Error("User Does Not Exist");case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 27:case"end":return e.stop()}},e,this,[[0,23]])}));return e}()},{key:"changePassword",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.hashPassword(this.data.password);case 3:return n=e.sent,e.next=6,pool.getConnection();case 6:return r=e.sent,e.next=9,r.query(this.sql,[n,t]);case 9:if(s=e.sent,!(s.changedRows>0)){e.next=28;break}if("string"!=typeof t){e.next=24;break}return e.next=14,r.query(this.secondSQL,[t]);case 14:if(o=e.sent,!(o.changedRows>0)){e.next=20;break}r.connection.release(),this.res.status(200).json({success:!0}),e.next=22;break;case 20:throw r.connection.release(),new Error("User Does Not Exist");case 22:e.next=26;break;case 24:r.connection.release(),this.res.status(200).json({success:!0});case 26:e.next=30;break;case 28:throw r.connection.release(),new Error("User Does Not Exist");case 30:e.next=36;break;case 32:e.prev=32,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 36:case"end":return e.stop()}},e,this,[[0,32]])}));return e}()},{key:"confirmUser",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.token]);case 6:if(n=e.sent,console.log(n.changedRows),!(n.changedRows>0)){e.next=13;break}t.connection.release(),this.res.status(200).json({success:!0}),e.next=15;break;case 13:throw t.connection.release(),new Error("User Does Not Exist");case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 21:case"end":return e.stop()}},e,this,[[0,17]])}));return e}()},{key:"register",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,o,a,i,c,u,l,h,p,f,w,d,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.data,n=t.email,r=t.password,s=t.first_name,o=t.last_name,a=t.phone,i={email:n,password:r,first_name:s,last_name:o,phone:a},c=randomstring.generate({length:20,charset:"hex"}),i.token=c,e.next=12,pool.getConnection();case 12:return u=e.sent,e.next=15,u.query(this.sql,[this.data.email]);case 15:if(l=e.sent,console.log(l),!(l.length>0)){e.next=22;break}throw u.connection.release(),new Error("Exists");case 22:return e.next=24,this.hashPassword(this.data.password);case 24:return h=e.sent,i.password=h,e.next=28,u.query(this.secondSQL,i);case 28:return p=e.sent,console.log(p),f="www.testsite.com",w="You are receiving this because you (or someone else) have signed up to the website.\n\n Please click on the following link, or paste this into your browser to completethe process:\n\n"+f+"/confirmEmail/"+i.token+"\n\n Once you have confirmed your account, you will be able to login.\n",d=new d(this.data.email,"userconfirmation@makeup.com","Confirm Account",w,this.res),e.next=35,d.sendTokenEmail();case 35:m=e.sent,m&&this.res.json({success:"Email has been sent"}),u.connection.release();case 38:e.next=44;break;case 40:e.prev=40,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 44:case"end":return e.stop()}},e,this,[[0,40]])}));return e}()},{key:"login",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,pool.getConnection();case 3:return t=e.sent,e.next=6,t.query(this.sql,[this.data.email]);case 6:if(n=e.sent,console.log("result",n),!(n.length>0)){e.next=22;break}return e.next=11,this.comparePassword(this.data.password,n[0].password);case 11:if(r=e.sent,!r){e.next=18;break}s=jwt.sign(n.user_id,secret,{expiresInMinutes:1440}),t.connection.release(),this.res.status(200).json({user_id:n[0].user_id,email:n[0].email,first_name:n[0].first_name,last_name:n[0].last_name,phone:n[0].phone,token:s}),e.next=20;break;case 18:throw t.connection.release(),new Error("Incorrect Password");case 20:e.next=24;break;case 22:throw t.connection.release(),new Error("User Does Not Exist");case 24:e.next=30;break;case 26:e.prev=26,e.t0=e.catch(0),console.log(e.t0),this.next(e.t0);case 30:case"end":return e.stop()}},e,this,[[0,26]])}));return e}()}]),e}();exports.default=AuthModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsL2F1dGhNb2RlbC5qcyJdLCJuYW1lcyI6WyJfZW1haWwiLCJyZXF1aXJlIiwiYmNyeXB0IiwicG9vbCIsInNhbHRSb3VuZHMiLCJyYW5kb21zdHJpbmciLCJqd3QiLCJzZWNyZXQiLCJBdXRoTW9kZWwiLCJkYXRhIiwicmVzIiwibmV4dCIsInNxbCIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsInNlY29uZFNRTCIsIl9jbGFzc0NhbGxDaGVjayIsInRoaXMiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwic2FsdCIsImhhc2giLCJkYlBhc3N3b3JkIiwiY29tcGFyZSIsInBhc3N3b3JkIiwiY29tcGFyaXNvblZhbHVlIiwiZ2V0Q29ubmVjdGlvbiIsImNvbm5lY3Rpb24iLCJxdWVyeSIsInRva2VuIiwiZW1haWwiLCJyZXN1bHQiLCJjaGFuZ2VkUm93cyIsInJlbGVhc2UiLCJ1cmwiLCJlbWFpbENvbnRlbnQiLCJQcm9taXNlIiwiZW1haWxSZXNwb25zZSIsInN1Y2Nlc3MiLCJFcnJvciIsImNvbnNvbGUiLCJsb2ciLCJfY29udGV4dCIsInQwIiwiaWRlbnRpZmllciIsImhhc2hQYXNzd29yZCIsImdlbmVyYXRlIiwiY2hhcnNldCIsImpzb24iLCJzdGF0dXMiLCJfY29udGV4dDIiLCJfY29udGV4dDMiLCJmaXJzdF9uYW1lIiwibGFzdF9uYW1lIiwicGhvbmUiLCJ1c2VyIiwicmVnaXN0ZXJUb2tlbiIsImVtYWlsQ2hlY2tSZXN1bHQiLCJpbnNlcnRSZXN1bHQiLCJyZWdpc3RlckVtYWlsQ29udGVudCIsIkVtYWlsIiwic2VuZFRva2VuRW1haWwiLCJfY29udGV4dDQiLCJtYXRjaCIsInNpZ24iLCJ1c2VyX2lkIiwiZXhwaXJlc0luTWludXRlcyIsInNlY29uZFJlc3VsdCIsIl9jb250ZXh0NSJdLCJtYXBwaW5ncyI6Inl5QkFJQUEsT0FBQUMsUUFBQSw0REFKSUMsT0FBU0QsUUFBUSxVQUNqQkUsS0FBT0YsUUFBUSxvQkFDYkcs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LEtBQU80QixnQkFBZTVCLEtBNkZvQlQsS0FBS2lCLFNBQVVPLEVBQU8sR0FBR1AscUJBQWpFdUMsVUFDRkEsbUJBQ0lsQyxFQUFRekIsSUFBSTRELEtBQUtqQyxFQUFPa0MsUUFBUzVELFFBQ3ZDNkQsaUJBQWtCLE9BR2xCdkMsRUFBV0EsV0FsR2dCQSxVQW1HM0JYLEtBQUtSLElBQUl5QyxPQUFPLEtBQUtELE1BQ25CaUIsUUFBU2xDLEVBQU8sR0FBR2tDLFFBcEdmRSxNQUFBQSxFQUFBQSxHQXFHYXJDLE1BQ2pCc0IsV0FBWXJCLEVBQU8sR0FBR3FCLFdBQ3RCQyxVQXRHRWMsRUFBQUEsR0FBQUEsVUF1R0ZiLE1BQU92QixFQUFPLEdBQUd1QixNQUNqQnpCLE1BQU9BLGlDQXZHUEYsR0FBQUEsV0FBV0EsVUFDWCxHQUFBWSxPQUFTVSwyREE2R2J0QixHQUFXQSxXQUFXTSxVQUNoQixHQUFJTSxPQUFNLGlGQTFHWlosUUFBQUEsSUFBQUEsRUFBQUEsSUE4R05YLEtBQUtQLEtBQUwyRCxFQUFBekIsZ0dBcE1OckMiLCJmaWxlIjoibW9kZWwvYXV0aE1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xudmFyIHBvb2wgPSByZXF1aXJlKCcuLi9kYi9jb25uZWN0LmpzJyk7XG5jb25zdCBzYWx0Um91bmRzID0gMTA7XG5jb25zdCByYW5kb21zdHJpbmcgPSByZXF1aXJlKCdyYW5kb21zdHJpbmcnKTtcbmltcG9ydCBFbWFpbCBmcm9tICcuLi9lbWFpbC9lbWFpbC5qcyc7XG52YXIgand0ID0gcmVxdWlyZSgnanNvbi13ZWItdG9rZW4nKTtcbnZhciBzZWNyZXQgPSByZXF1aXJlKCcuLi9nZW5lcmFsL2p3dFNlY3JldC5qcycpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBdXRoTW9kZWwge1xuXG4gIGNvbnN0cnVjdG9yKGRhdGEsIHJlcywgbmV4dCwgc3FsID0gJycsIHNlY29uZFNRTCA9ICcnKSB7XG4gICAgdGhpcy5zcWwgPSBzcWw7XG4gICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICB0aGlzLnJlcyA9IHJlcztcbiAgICB0aGlzLm5leHQgPSBuZXh0O1xuICAgIHRoaXMuc2Vjb25kU1FMID0gc2Vjb25kU1FMO1xuICB9XG5cbiAgaGFzaFBhc3N3b3JkKHBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+ICB7XG4gICAgICBiY3J5cHQuZ2VuU2FsdChzYWx0Um91bmRzLCAoZXJyLCBzYWx0KSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICBiY3J5cHQuaGFzaChwYXNzd29yZCwgc2FsdCwgKGVyciwgaGFzaCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKGhhc2gpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pXG4gIH1cblxuICBjb21wYXJlUGFzc3dvcmQocGFzc3dvcmQsIGRiUGFzc3dvcmQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIGRiUGFzc3dvcmQsIChlcnIsIGNvbXBhcmlzb25WYWx1ZSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZShjb21wYXJpc29uVmFsdWUpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmb3Jnb3RQYXNzd29yZFNldHVwKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG4gICAgICBjb25zdCB0b2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICAgIGxlbmd0aDogMjAsXG4gICAgICAgIGNoYXJzZXQ6ICdoZXgnXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0b2tlbiwgdGhpcy5kYXRhLmVtYWlsXSk7XG4gICAgICBpZiAocmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICBjb25zdCB1cmwgPSAnd3d3LnRlc3RzaXRlLmNvbSc7XG4gICAgICAgIHZhciBlbWFpbENvbnRlbnQgPSAnWW91IGFyZSByZWNlaXZpbmcgdGhpcyBiZWNhdXNlIHlvdSBoYXZlIHJlcXVlc3RlZCB0byByZXNldCB5b3VyIHBhc3N3b3JkLiAnICtcbiAgICAgICAgJ1BsZWFzZSBjbGljayBvbiB0aGUgZm9sbG93aW5nIGxpbmssIG9yIHBhc3RlIHRoaXMgaW50byB5b3VyIGJyb3dzZXIgdG8gY29tcGxldGUnICtcbiAgICAgICAgICd0aGUgcHJvY2VzczpcXG5cXG4nICsgdXJsICsgJy9yZXNldEZvcmdvdHRlblBhc3N3b3JkLycgKyB0b2tlbiArICdcXG5cXG4gQWZ0ZXIgY29uZmlybWluZyB5b3VyIHBhc3N3b3JkJyArXG4gICAgICAgICAnIHlvdSB3aWxsIGJlIGFibGUgdG8gbG9naW4uXFxuJztcbiAgICAgICAgdmFyIGVtYWlsID0gbmV3IEVtYWlsKHRoaXMuZGF0YS5lbWFpbCwgJ2ZvcmdvdHRlbi1wYXNzd29yZEBtYWtldXAuY29tJywgJ0ZvcmdvdHRlbiBQYXNzd29yZCcsIGVtYWlsQ29udGVudCwgdGhpcy5yZXMpO1xuICAgICAgICBjb25zdCBlbWFpbFJlc3BvbnNlID0gYXdhaXQgZW1haWwuc2VuZFRva2VuRW1haWwoKTtcbiAgICAgICAgaWYgKGVtYWlsUmVzcG9uc2UpIHtcbiAgICAgICAgICB0aGlzLnJlcy5qc29uKHtzdWNjZXNzOiAnRW1haWwgaGFzIGJlZW4gc2VudCd9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2VyIERvZXMgTm90IEV4aXN0Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICB0aGlzLm5leHQoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2hhbmdlUGFzc3dvcmQoaWRlbnRpZmllcikge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBoYXNoID0gYXdhaXQgdGhpcy5oYXNoUGFzc3dvcmQodGhpcy5kYXRhLnBhc3N3b3JkKTtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCBwb29sLmdldENvbm5lY3Rpb24oKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFtoYXNoLCBpZGVudGlmaWVyXSk7XG4gICAgICBpZiAocmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICAvLyBpZiB0aGUgaWRlbnRpZmllciB3YXMgdGhlIHRva2VuIC0gZG8gYW5vdGhlciBxdWVyeSB3aGljaCByZW1vdmVzIHRoZSB0b2tlblxuICAgICAgICBpZiAodHlwZW9mIGlkZW50aWZpZXIgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgY29uc3Qgc2Vjb25kUmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNlY29uZFNRTCwgW2lkZW50aWZpZXJdKTtcbiAgICAgICAgICBpZiAoc2Vjb25kUmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHsgLy8gbm9ybWFsIGNoYW5nZSBwYXNzd29yZCAtIHNlbmQgc3VjY2Vzc1xuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNvbmZpcm1Vc2VyKCkge1xuICAgIHRyeSB7XG4gICAgICB2YXIgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgdmFyIHJlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEudG9rZW5dKTtcbiAgICAgIGNvbnNvbGUubG9nKHJlc3VsdC5jaGFuZ2VkUm93cyk7XG4gICAgICBpZiAocmVzdWx0LmNoYW5nZWRSb3dzID4gMCkge1xuICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRoaXMucmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyAgaG93IHRoZSBteXNxbCBsaWJyYXJ5IGlzIHdyYXBwZWQgLSBzdGFja292ZXJmbG93XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlZ2lzdGVyKCkge1xuICAgIHRyeSB7XG4gICAgICB2YXIge2VtYWlsLCBwYXNzd29yZCwgZmlyc3RfbmFtZSwgbGFzdF9uYW1lLCBwaG9uZX0gPSB0aGlzLmRhdGE7XG4gICAgICB2YXIgdXNlciA9IHtlbWFpbCwgcGFzc3dvcmQsIGZpcnN0X25hbWUsIGxhc3RfbmFtZSwgcGhvbmV9O1xuICAgICAgY29uc3QgcmVnaXN0ZXJUb2tlbiA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSh7XG4gICAgICAgIGxlbmd0aDogMjAsXG4gICAgICAgIGNoYXJzZXQ6ICdoZXgnXG4gICAgICB9KTtcbiAgICAgIHVzZXIudG9rZW4gPSByZWdpc3RlclRva2VuO1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgZW1haWxDaGVja1Jlc3VsdCA9IGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkodGhpcy5zcWwsIFt0aGlzLmRhdGEuZW1haWxdKTtcbiAgICAgIGNvbnNvbGUubG9nKGVtYWlsQ2hlY2tSZXN1bHQpO1xuICAgICAgaWYgKGVtYWlsQ2hlY2tSZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4aXN0cycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IHRoaXMuaGFzaFBhc3N3b3JkKHRoaXMuZGF0YS5wYXNzd29yZCk7XG4gICAgICAgIHVzZXIucGFzc3dvcmQgPSBoYXNoO1xuICAgICAgICBjb25zdCBpbnNlcnRSZXN1bHQgPSBhd2FpdCBjb25uZWN0aW9uLnF1ZXJ5KHRoaXMuc2Vjb25kU1FMLCB1c2VyKTtcbiAgICAgICAgY29uc29sZS5sb2coaW5zZXJ0UmVzdWx0KTtcbiAgICAgICAgdmFyIHVybCA9ICd3d3cudGVzdHNpdGUuY29tJztcbiAgICAgICAgdmFyIHJlZ2lzdGVyRW1haWxDb250ZW50ID0gJ1lvdSBhcmUgcmVjZWl2aW5nIHRoaXMgYmVjYXVzZSB5b3UgKG9yIHNvbWVvbmUgZWxzZSkgaGF2ZSBzaWduZWQgdXAgJyArXG4gICAgICAgICd0byB0aGUgd2Vic2l0ZS5cXG5cXG4gUGxlYXNlIGNsaWNrIG9uIHRoZSBmb2xsb3dpbmcgbGluaywgb3IgcGFzdGUgdGhpcyBpbnRvIHlvdXIgYnJvd3NlciB0byBjb21wbGV0ZScgK1xuICAgICAgICAgJ3RoZSBwcm9jZXNzOlxcblxcbicgKyB1cmwgKyAnL2NvbmZpcm1FbWFpbC8nICsgdXNlci50b2tlbiArICdcXG5cXG4gT25jZSB5b3UgaGF2ZSBjb25maXJtZWQgeW91ciBhY2NvdW50LCcgK1xuICAgICAgICAgJyB5b3Ugd2lsbCBiZSBhYmxlIHRvIGxvZ2luLlxcbic7XG4gICAgICAgIHZhciBFbWFpbCA9IG5ldyBFbWFpbCh0aGlzLmRhdGEuZW1haWwsICd1c2VyY29uZmlybWF0aW9uQG1ha2V1cC5jb20nLCAnQ29uZmlybSBBY2NvdW50JywgcmVnaXN0ZXJFbWFpbENvbnRlbnQsIHRoaXMucmVzKTtcbiAgICAgICAgY29uc3QgZW1haWxSZXNwb25zZSA9IGF3YWl0IEVtYWlsLnNlbmRUb2tlbkVtYWlsKCk7XG4gICAgICAgIGlmIChlbWFpbFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5yZXMuanNvbih7c3VjY2VzczogJ0VtYWlsIGhhcyBiZWVuIHNlbnQnfSk7XG4gICAgICAgIH1cbiAgICAgICAgY29ubmVjdGlvbi5jb25uZWN0aW9uLnJlbGVhc2UoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgIHRoaXMubmV4dChlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2dpbigpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHBvb2wuZ2V0Q29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubmVjdGlvbi5xdWVyeSh0aGlzLnNxbCwgW3RoaXMuZGF0YS5lbWFpbF0pO1xuICAgICAgY29uc29sZS5sb2coJ3Jlc3VsdCcsIHJlc3VsdCk7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSBhd2FpdCB0aGlzLmNvbXBhcmVQYXNzd29yZCh0aGlzLmRhdGEucGFzc3dvcmQsIHJlc3VsdFswXS5wYXNzd29yZCk7XG4gICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24ocmVzdWx0LnVzZXJfaWQsIHNlY3JldCwge1xuICAgICAgICAgIGV4cGlyZXNJbk1pbnV0ZXM6IDE0NDAgLy8gZXhwaXJlcyBpbiAyNCBob3Vyc1xuICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgICAgdGhpcy5yZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICB1c2VyX2lkOiByZXN1bHRbMF0udXNlcl9pZCxcbiAgICAgICAgICAgIGVtYWlsOiByZXN1bHRbMF0uZW1haWwsXG4gICAgICAgICAgICBmaXJzdF9uYW1lOiByZXN1bHRbMF0uZmlyc3RfbmFtZSxcbiAgICAgICAgICAgIGxhc3RfbmFtZTogcmVzdWx0WzBdLmxhc3RfbmFtZSxcbiAgICAgICAgICAgIHBob25lOiByZXN1bHRbMF0ucGhvbmUsXG4gICAgICAgICAgICB0b2tlbjogdG9rZW5cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmNvbm5lY3Rpb24ucmVsZWFzZSgpO1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5jb3JyZWN0IFBhc3N3b3JkJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5yZWxlYXNlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBEb2VzIE5vdCBFeGlzdCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgdGhpcy5uZXh0KGUpO1xuICAgIH1cbiAgfVxuXG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
